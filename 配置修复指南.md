# ⚠️ 配置修复指南 - 紧急

## 🔴 当前问题

您的 `config.json` 配置存在**严重问题**，会导致频繁触发 Apple API 限制（HTTP 541错误）。

### 当前配置分析

```json
{
  "target_products": [1个],
  "target_stores": [8个],
  "check_interval": 10
}
```

**计算结果：**

```
一轮耗时 = 8个门店 × 1秒 = 8秒
总周期 = 8 + 10 = 18秒
请求频率 = (1 × 8) / 18 × 60 = 26.67次/分钟 ⚠️
```

**问题：**
- ❌ 实际频率：**26.67次/分钟**
- ❌ 安全标准：≤ 10次/分钟
- ❌ **超标266%！**
- ❌ 触发概率：**90%以上**

---

## ✅ 解决方案

### 方案A：减少门店（推荐）⭐

**修改配置文件：**

```json
{
  "target_products": [
    {
      "name": "iPhone 16 Plus 白色 128GB",
      "part_number": "MXUA3CH/A",
      "color": "白色",
      "storage": "128G",
      "series": "iPhone 16 plus"
    }
  ],
  "all_stores": false,
  "target_stores": [
    "R359",
    "R389",
    "R401",
    "R581",
    "R678"
  ],
  "check_interval": 30
}
```

**修改说明：**
- 门店数：8个 → 5个（减少3个）
- 间隔：10秒 → 30秒（增加20秒）

**修改后结果：**
```
一轮耗时 = 5个门店 × 1秒 = 5秒
总周期 = 5 + 30 = 35秒
请求频率 = 8.57次/分钟 ✅ 安全！
```

**优点：**
- ✅ 完全安全
- ✅ 仍能监控主要门店
- ✅ 可长时间稳定运行

**如何操作：**

```bash
# 1. 备份当前配置
cp config.json config.json.backup

# 2. 使用安全配置
cp config_safe.json config.json

# 3. 重启程序
python3 main.py
```

---

### 方案B：增加间隔

**修改配置文件：**

```json
{
  "target_products": [1个],
  "target_stores": [8个],  // 保持8个门店
  "check_interval": 48      // 增加到48秒
}
```

**修改后结果：**
```
一轮耗时 = 8秒
总周期 = 56秒
请求频率 = 8.57次/分钟 ✅ 安全！
```

**优点：**
- ✅ 完全安全
- ✅ 保留所有8个门店

**缺点：**
- ⚠️ 检查频率较慢（56秒一轮）
- ⚠️ 可能错过快速补货

---

### 方案C：平衡方案

**修改配置文件：**

```json
{
  "target_products": [1个],
  "target_stores": [6个],  // 减少到6个
  "check_interval": 36     // 增加到36秒
}
```

**修改后结果：**
```
一轮耗时 = 6秒
总周期 = 42秒
请求频率 = 8.57次/分钟 ✅ 安全！
```

**优点：**
- ✅ 完全安全
- ✅ 平衡了门店数和速度
- ✅ 42秒一轮，适中

---

## 🛠️ 使用计算工具

我们提供了一个实用工具来帮助您计算配置是否安全：

```bash
# 分析当前配置
python3 rate_calculator.py

# 选择 1 - 分析config.json
```

**工具功能：**
- ✅ 自动计算请求频率
- ✅ 评估风险级别
- ✅ 提供修复建议
- ✅ 显示推荐配置

---

## 📋 快速修复步骤

### 1 分钟快速修复：

```bash
# 步骤1：备份当前配置
cp config.json config.json.backup

# 步骤2：使用安全配置（已为您准备好）
cp config_safe.json config.json

# 步骤3：验证配置
python3 rate_calculator.py

# 步骤4：重启程序
python3 main.py
```

完成！您的配置现在已经安全了。

---

## 🔢 配置计算公式

如果您想自定义配置，请使用以下公式：

```
请求频率（次/分钟）= (产品数 × 门店数) / (门店数 × 1秒 + 检查间隔) × 60

安全要求：请求频率 ≤ 10次/分钟
```

**示例计算：**

```python
# 您想监控的配置
产品数 = 1
门店数 = ?  # 待计算
检查间隔 = 30秒

# 计算最大门店数
最大门店数 = (10 × (门店数 + 30)) / 60 - 门店数
           ≈ 5个门店

# 验证
请求频率 = (1 × 5) / (5 + 30) × 60 = 8.57次/分钟 ✅
```

---

## 📊 推荐配置对照表

| 门店数 | 最小间隔 | 推荐间隔 | 频率 | 风险 |
|--------|---------|---------|------|------|
| 1个 | 6秒 | 6秒 | 10次/分 | ✅ 安全 |
| 3个 | 14秒 | 18秒 | 8.57次/分 | ✅ 安全 |
| 5个 | 24秒 | 30秒 | 8.57次/分 | ✅ 安全 |
| 8个 | 42秒 | 48秒 | 8.57次/分 | ✅ 安全 |
| 10个 | 54秒 | 60秒 | 10次/分 | ✅ 安全 |

**注：** 单产品情况下

---

## ⚠️ 常见错误配置

### 错误1：间隔太短

```json
{
  "target_stores": [8个],
  "check_interval": 5  // ❌ 太短
}
```

**结果：** 96次/分钟 - **必定触发限制**

### 错误2：门店太多

```json
{
  "target_stores": [20个],  // ❌ 太多
  "check_interval": 30
}
```

**结果：** 40次/分钟 - **必定触发限制**

### 错误3：多开程序

```bash
# ❌ 同时运行多个程序
python3 main.py &
python3 main.py &
```

**结果：** 频率叠加 - **必定触发限制**

---

## 🎯 最佳实践

### 1. 单产品监控（推荐）

```json
{
  "target_products": [1个],
  "target_stores": [5个],
  "check_interval": 30
}
```

**特点：**
- ✅ 8.57次/分钟
- ✅ 完全安全
- ✅ 可长时间运行

### 2. 多产品监控

```json
{
  "target_products": [2个],
  "target_stores": [5个],
  "check_interval": 60
}
```

**特点：**
- ✅ 10次/分钟
- ✅ 可监控多个型号
- ⚠️ 速度较慢

### 3. 快速监控（短期）

```json
{
  "target_products": [1个],
  "target_stores": [2个],
  "check_interval": 12
}
```

**特点：**
- ✅ 10次/分钟
- ✅ 快速响应
- ⚠️ 只监控2个门店

---

## 🔍 如何选择门店

### 优先选择这些门店：

**上海地区（推荐）：**
```json
"target_stores": [
  "R359",  // 南京东路 - 旗舰店，货源充足
  "R389",  // 浦东 - 大店
  "R401",  // 环贸iapm - 市中心
  "R581",  // 五角场 - 大学城
  "R678"   // 静安 - 新店
]
```

**北京地区：**
```json
"target_stores": [
  "R448",  // 王府井 - 旗舰店
  "R479",  // 华贸 - 货源好
  "R645"   // 朝阳大悦城 - 新店
]
```

**全国热门：**
```json
"target_stores": [
  "R448",  // 北京王府井
  "R359",  // 上海南京东路
  "R484",  // 深圳益田
  "R577",  // 广州天环
  "R580"   // 成都太古里
]
```

---

## 📝 修复检查清单

完成以下检查后，您的配置就是安全的：

- [ ] **计算请求频率** - 使用 `rate_calculator.py`
- [ ] **确保 ≤ 10次/分钟** - 必须满足
- [ ] **门店数 ≤ 5个**（30秒间隔）- 推荐
- [ ] **check_interval ≥ 30秒**（多门店）- 推荐
- [ ] **备份旧配置** - 以防需要恢复
- [ ] **测试新配置** - 运行10分钟观察
- [ ] **监控日志** - 确保没有HTTP 541错误

---

## 🆘 仍然遇到问题？

### 1. 查看日志

```bash
tail -f monitor.log
```

**查找这些关键词：**
- `HTTP 541` - API限制
- `连续错误` - 频繁触发
- `跳过门店` - 保护机制启动

### 2. 使用计算工具

```bash
python3 rate_calculator.py
```

### 3. 使用安全配置

```bash
cp config_safe.json config.json
```

---

## ✅ 修复完成确认

修复完成后，您应该看到：

```
✅ 程序稳定运行
✅ 没有HTTP 541错误
✅ 日志显示正常查询
✅ 可以长时间运行不中断
```

**恭喜！您的配置现在是安全的了。**

---

**文档生成时间：** 2025-10-06  
**目的：** 修复当前config.json的安全问题  
**重要性：** ⭐⭐⭐⭐⭐ 必须立即修复


