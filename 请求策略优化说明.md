# ğŸ¯ è¯·æ±‚ç­–ç•¥ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“Š å½“å‰é—®é¢˜

### ç°æœ‰é€»è¾‘ï¼ˆä¸å¤Ÿä¼˜åŒ–ï¼‰

```python
# å½“å‰å¯èƒ½çš„é€»è¾‘
for product in products:  # äº§å“1, äº§å“2, äº§å“3
    for store in stores:  # é—¨åº—1, é—¨åº—2, é—¨åº—3
        å‘é€è¯·æ±‚(product, store)
        sleep(1ç§’)

# è¯·æ±‚é¡ºåºï¼š
äº§å“1-é—¨åº—1 â†’ äº§å“1-é—¨åº—2 â†’ äº§å“1-é—¨åº—3 â†’ 
äº§å“2-é—¨åº—1 â†’ äº§å“2-é—¨åº—2 â†’ äº§å“2-é—¨åº—3 â†’ 
äº§å“3-é—¨åº—1 â†’ äº§å“3-é—¨åº—2 â†’ äº§å“3-é—¨åº—3
```

**é—®é¢˜ï¼š**
- âŒ æ¨¡å¼å¤ªè§„å¾‹ï¼ˆå®¹æ˜“è¢«è¯†åˆ«ä¸ºæœºå™¨äººï¼‰
- âŒ åŒä¸€äº§å“è¿ç»­æŸ¥è¯¢å¤šä¸ªé—¨åº—ï¼ˆä¸è‡ªç„¶ï¼‰
- âŒ å›ºå®šé—´éš”ï¼ˆå¤ªè§„å¾‹ï¼‰

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆï¼šéšæœºæ‰“æ•£ç­–ç•¥

### æ ¸å¿ƒæ€æƒ³

**å°†æ‰€æœ‰"äº§å“-é—¨åº—"ç»„åˆæ‰“æ•£ï¼Œéšæœºé¡ºåºé€ä¸ªå‘é€**

```python
# ä¼˜åŒ–åçš„é€»è¾‘
ç»„åˆåˆ—è¡¨ = []
for product in products:
    for store in stores:
        ç»„åˆåˆ—è¡¨.append((product, store))

# æ‰“ä¹±é¡ºåº
random.shuffle(ç»„åˆåˆ—è¡¨)

# é€ä¸ªå‘é€ï¼Œéšæœºé—´éš”
for (product, store) in ç»„åˆåˆ—è¡¨:
    å‘é€è¯·æ±‚(product, store)
    éšæœºå»¶è¿Ÿ(3-6ç§’)  # éšæœºé—´éš”
```

**ä¼˜åŠ¿ï¼š**
- âœ… è¯·æ±‚é¡ºåºéšæœºï¼ˆæ›´åƒäººç±»è¡Œä¸ºï¼‰
- âœ… ä¸ä¼šè¿ç»­æŸ¥è¯¢åŒä¸€äº§å“æˆ–åŒä¸€é—¨åº—
- âœ… é—´éš”æ—¶é—´éšæœºï¼ˆéš¾ä»¥è¢«è¯†åˆ«ï¼‰
- âœ… å®Œå…¨æ‰“æ•£ï¼Œæ— è§„å¾‹å¯å¾ª

---

## ğŸ”§ å…·ä½“å®ç°

### 1. ä¿®æ”¹ apple_store_monitor.py

```python
import random

def check_multiple_products_optimized(self, products, stores=None):
    """
    ä¼˜åŒ–çš„å¤šäº§å“ç›‘æ§ - éšæœºæ‰“æ•£ç­–ç•¥
    """
    if stores is None:
        stores = self.target_stores
    
    # æ­¥éª¤1: ç”Ÿæˆæ‰€æœ‰ç»„åˆ
    combinations = []
    for product in products:
        for store in stores:
            combinations.append({
                'product': product,
                'store': store
            })
    
    # æ­¥éª¤2: éšæœºæ‰“ä¹±é¡ºåº
    random.shuffle(combinations)
    
    logger.info(f"ğŸ“Š æœ¬è½®å°†æ£€æŸ¥ {len(combinations)} ä¸ªç»„åˆï¼ˆå·²éšæœºæ‰“æ•£ï¼‰")
    
    # æ­¥éª¤3: é€ä¸ªå‘é€è¯·æ±‚ï¼Œéšæœºé—´éš”
    results = []
    error_count = 0
    
    for i, combo in enumerate(combinations, 1):
        product = combo['product']
        store = combo['store']
        
        # å‘é€è¯·æ±‚
        result = self.check_product_availability(
            product['part_number'],
            store
        )
        
        results.append(result)
        
        # æ£€æµ‹ HTTP 541
        if 'HTTP 541' in str(result.get('error', '')):
            error_count += 1
            logger.warning(f"âš ï¸  APIé™åˆ¶è­¦å‘Š ({error_count}/3)")
            
            if error_count >= 3:
                logger.error(f"ğŸ›‘ è¿ç»­è§¦å‘é™åˆ¶ï¼Œåœæ­¢æœ¬è½®å‰©ä½™ {len(combinations) - i} ä¸ªè¯·æ±‚")
                break
        else:
            error_count = 0  # æˆåŠŸåé‡ç½®
        
        # éšæœºå»¶è¿Ÿï¼ˆæœ€åä¸€ä¸ªä¸å»¶è¿Ÿï¼‰
        if i < len(combinations):
            delay = self._random_delay(
                min_delay=3,
                max_delay=6,
                base_delay=4.5
            )
            logger.debug(f"â³ ç­‰å¾… {delay:.1f} ç§’åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...")
            self._interruptible_sleep(delay)
    
    return results

def _random_delay(self, min_delay=3, max_delay=6, base_delay=4.5):
    """
    ç”Ÿæˆéšæœºå»¶è¿Ÿæ—¶é—´
    
    Args:
        min_delay: æœ€å°å»¶è¿Ÿï¼ˆç§’ï¼‰
        max_delay: æœ€å¤§å»¶è¿Ÿï¼ˆç§’ï¼‰
        base_delay: åŸºå‡†å»¶è¿Ÿï¼ˆç§’ï¼‰ï¼Œç”¨äºæ­£æ€åˆ†å¸ƒ
    
    Returns:
        éšæœºå»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰
    """
    # æ–¹æ³•1: å‡åŒ€åˆ†å¸ƒï¼ˆç®€å•ï¼‰
    # return random.uniform(min_delay, max_delay)
    
    # æ–¹æ³•2: æ­£æ€åˆ†å¸ƒï¼ˆæ›´è‡ªç„¶ï¼‰
    delay = random.gauss(base_delay, 0.8)  # å‡å€¼4.5ç§’ï¼Œæ ‡å‡†å·®0.8
    
    # é™åˆ¶åœ¨èŒƒå›´å†…
    delay = max(min_delay, min(max_delay, delay))
    
    return delay
```

---

### 2. é…ç½®æ–‡ä»¶ç¤ºä¾‹

#### ä¼˜åŒ–å‰ï¼ˆé—®é¢˜é…ç½®ï¼‰

```json
{
  "target_products": [
    {"name": "iPhone 17 Pro Max é“¶è‰² 256GB", "part_number": "MG034CH/A"},
    {"name": "iPhone 17 Pro Max æ©™è‰² 256GB", "part_number": "MG044CH/A"},
    {"name": "iPhone 17 Pro Max è“è‰² 256GB", "part_number": "MG054CH/A"}
  ],
  "target_stores": ["R320", "R448", "R359", "R401", "R484"],
  "check_interval": 30
}
```

**åˆ†æï¼š**
- 3äº§å“ Ã— 5é—¨åº— = 15ä¸ªè¯·æ±‚
- æŒ‰ç°æœ‰é€»è¾‘ï¼šäº§å“1éå†5åº— â†’ äº§å“2éå†5åº— â†’ äº§å“3éå†5åº—
- é—´éš”ï¼š1ç§’ï¼ˆå›ºå®šï¼‰
- é—®é¢˜ï¼šæ¨¡å¼è§„å¾‹ï¼Œå®¹æ˜“è¢«è¯†åˆ«

#### ä¼˜åŒ–åï¼ˆæ¨èé…ç½®ï¼‰

```json
{
  "target_products": [
    {"name": "iPhone 17 Pro Max é“¶è‰² 256GB", "part_number": "MG034CH/A"},
    {"name": "iPhone 17 Pro Max æ©™è‰² 256GB", "part_number": "MG044CH/A"}
  ],
  "target_stores": ["R320", "R448", "R359"],
  "check_interval": 60,
  "randomize_order": true,
  "random_delay": {
    "min": 3,
    "max": 6,
    "base": 4.5
  }
}
```

**åˆ†æï¼š**
- 2äº§å“ Ã— 3é—¨åº— = 6ä¸ªè¯·æ±‚
- é¡ºåºï¼šéšæœºæ‰“æ•£ï¼ˆæ¯è½®ä¸åŒï¼‰
- é—´éš”ï¼š3-6ç§’éšæœº
- ä¸€è½®ï¼šçº¦30ç§’ï¼ˆ6æ¬¡ Ã— 5ç§’å¹³å‡ï¼‰
- æ€»å‘¨æœŸï¼š30 + 60 = 90ç§’
- é¢‘ç‡ï¼š6æ¬¡/90ç§’ = 4æ¬¡/åˆ†é’Ÿ âœ… **æå…¶å®‰å…¨ï¼**

---

## ğŸ“Š è¯·æ±‚é¡ºåºå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆè§„å¾‹æ˜æ˜¾ï¼‰

```
ç¬¬1è½®:
09:00:00 - äº§å“1-é—¨åº—1
09:00:01 - äº§å“1-é—¨åº—2
09:00:02 - äº§å“1-é—¨åº—3
09:00:03 - äº§å“2-é—¨åº—1
09:00:04 - äº§å“2-é—¨åº—2
09:00:05 - äº§å“2-é—¨åº—3
... ç­‰å¾…30ç§’

ç¬¬2è½®:
09:00:36 - äº§å“1-é—¨åº—1  â† å®Œå…¨é‡å¤ç¬¬1è½®é¡ºåº
09:00:37 - äº§å“1-é—¨åº—2
...
```

**é—®é¢˜ï¼š** å¤ªè§„å¾‹ï¼å®¹æ˜“è¢«è¯†åˆ«ä¸ºæœºå™¨äºº

---

### ä¼˜åŒ–åï¼ˆéšæœºæ‰“æ•£ï¼‰

```
ç¬¬1è½®:
09:00:00 - äº§å“2-é—¨åº—3 (éšæœºå»¶è¿Ÿ5.2ç§’)
09:00:05 - äº§å“1-é—¨åº—1 (éšæœºå»¶è¿Ÿ3.8ç§’)
09:00:09 - äº§å“2-é—¨åº—1 (éšæœºå»¶è¿Ÿ4.6ç§’)
09:00:14 - äº§å“1-é—¨åº—3 (éšæœºå»¶è¿Ÿ5.5ç§’)
09:00:19 - äº§å“1-é—¨åº—2 (éšæœºå»¶è¿Ÿ4.1ç§’)
09:00:23 - äº§å“2-é—¨åº—2
... ç­‰å¾…60ç§’

ç¬¬2è½®:
09:01:24 - äº§å“1-é—¨åº—2 (éšæœºå»¶è¿Ÿ4.8ç§’) â† é¡ºåºå®Œå…¨ä¸åŒï¼
09:01:29 - äº§å“2-é—¨åº—1 (éšæœºå»¶è¿Ÿ3.5ç§’)
09:01:33 - äº§å“1-é—¨åº—3 (éšæœºå»¶è¿Ÿ5.9ç§’)
09:01:39 - äº§å“2-é—¨åº—3 (éšæœºå»¶è¿Ÿ4.2ç§’)
09:01:43 - äº§å“1-é—¨åº—1 (éšæœºå»¶è¿Ÿ5.1ç§’)
09:01:48 - äº§å“2-é—¨åº—2
... ç­‰å¾…60ç§’
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ¯è½®é¡ºåºä¸åŒ
- âœ… é—´éš”æ—¶é—´ä¸å›ºå®š
- âœ… å®Œå…¨éšæœºï¼Œæ— è§„å¾‹
- âœ… æ›´åƒäººç±»è¡Œä¸º

---

## ğŸ¯ ä¸åŒè§„æ¨¡çš„æœ€ä½³é…ç½®

### å°è§„æ¨¡ç›‘æ§ï¼ˆ2äº§å“ Ã— 3é—¨åº—ï¼‰

```json
{
  "target_products": [2ä¸ª],
  "target_stores": [3ä¸ª],
  "check_interval": 60,
  "random_delay": {"min": 3, "max": 6}
}
```

- 6ä¸ªç»„åˆï¼Œéšæœºé¡ºåº
- é—´éš”ï¼š3-6ç§’
- ä¸€è½®ï¼šçº¦30ç§’
- é¢‘ç‡ï¼š4æ¬¡/åˆ†é’Ÿ âœ…

---

### ä¸­è§„æ¨¡ç›‘æ§ï¼ˆ3äº§å“ Ã— 4é—¨åº—ï¼‰

```json
{
  "target_products": [3ä¸ª],
  "target_stores": [4ä¸ª],
  "check_interval": 90,
  "random_delay": {"min": 4, "max": 7}
}
```

- 12ä¸ªç»„åˆï¼Œéšæœºé¡ºåº
- é—´éš”ï¼š4-7ç§’
- ä¸€è½®ï¼šçº¦66ç§’
- é¢‘ç‡ï¼š7.7æ¬¡/åˆ†é’Ÿ âœ…

---

### å¤§è§„æ¨¡ç›‘æ§ï¼ˆ4äº§å“ Ã— 5é—¨åº—ï¼‰

```json
{
  "target_products": [4ä¸ª],
  "target_stores": [5ä¸ª],
  "check_interval": 150,
  "random_delay": {"min": 5, "max": 8}
}
```

- 20ä¸ªç»„åˆï¼Œéšæœºé¡ºåº
- é—´éš”ï¼š5-8ç§’
- ä¸€è½®ï¼šçº¦130ç§’
- é¢‘ç‡ï¼š9.2æ¬¡/åˆ†é’Ÿ âœ…

---

## ğŸ›¡ï¸ é¢å¤–é˜²æŠ¤æªæ–½

### 1. æ¯è½®é‡æ–°æ‰“æ•£

```python
# æ¯è½®æ£€æŸ¥æ—¶éƒ½é‡æ–°æ‰“ä¹±é¡ºåº
def monitor_loop(self):
    while not self.stop_event.is_set():
        # æ¯è½®éƒ½é‡æ–°ç”Ÿæˆå¹¶æ‰“ä¹±ç»„åˆ
        combinations = self._generate_combinations()
        random.shuffle(combinations)  # æ¯è½®é¡ºåºä¸åŒ
        
        for combo in combinations:
            ...
```

### 2. éšæœº User-Agent

```python
USER_AGENTS = [
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) Safari/605.1.15',
]

# æ¯ä¸ªè¯·æ±‚éšæœºé€‰æ‹©
headers['User-Agent'] = random.choice(USER_AGENTS)
```

### 3. åŠ¨æ€è°ƒæ•´é—´éš”

```python
# æ ¹æ®æ—¶é—´æ®µè°ƒæ•´é—´éš”
current_hour = datetime.now().hour

if 9 <= current_hour <= 11:  # ä¸Šç­é«˜å³°
    delay = random.uniform(6, 10)  # æ›´é•¿é—´éš”
elif 20 <= current_hour <= 22:  # æ™šä¸Šé«˜å³°
    delay = random.uniform(6, 10)
else:  # å…¶ä»–æ—¶æ®µ
    delay = random.uniform(4, 6)
```

---

## ğŸ“‹ å®ç°æ­¥éª¤

### æ­¥éª¤1: ä¿®æ”¹ç›‘æ§ç±»

åœ¨ `apple_store_monitor.py` ä¸­ï¼š

```python
def check_multiple_products(self, products, stores=None):
    """
    ä¼˜åŒ–ç‰ˆæœ¬ï¼šéšæœºæ‰“æ•£ç­–ç•¥
    """
    # 1. ç”Ÿæˆæ‰€æœ‰ç»„åˆ
    combinations = []
    for product in products:
        for store in (stores or self.target_stores):
            combinations.append((product, store))
    
    # 2. éšæœºæ‰“ä¹±
    random.shuffle(combinations)
    
    # 3. é€ä¸ªè¯·æ±‚ï¼Œéšæœºé—´éš”
    results = []
    for i, (product, store) in enumerate(combinations):
        result = self.check_product_availability(
            product['part_number'], 
            store
        )
        results.append(result)
        
        # éšæœºå»¶è¿Ÿ
        if i < len(combinations) - 1:
            delay = random.uniform(3, 6)
            self._interruptible_sleep(delay)
    
    return results
```

### æ­¥éª¤2: æ›´æ–°é…ç½®

```json
{
  "randomize_order": true,
  "random_delay": {
    "enabled": true,
    "min": 3,
    "max": 6
  }
}
```

### æ­¥éª¤3: æµ‹è¯•éªŒè¯

```bash
# è¿è¡Œç›‘æ§ï¼Œè§‚å¯Ÿæ—¥å¿—
python3 main.py

# æ—¥å¿—åº”æ˜¾ç¤ºï¼š
ğŸ“Š æœ¬è½®æ£€æŸ¥ 6 ä¸ªç»„åˆï¼ˆå·²éšæœºæ‰“æ•£ï¼‰
â³ ç­‰å¾… 4.8 ç§’åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
â³ ç­‰å¾… 5.2 ç§’åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
â³ ç­‰å¾… 3.9 ç§’åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
```

---

## ğŸŠ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **æ‰“æ•£ç»„åˆ** - å°†äº§å“Ã—é—¨åº—çš„æ‰€æœ‰ç»„åˆæ‰“æ•£
2. **éšæœºé¡ºåº** - æ¯è½®éƒ½é‡æ–°æ‰“ä¹±é¡ºåº
3. **éšæœºé—´éš”** - 3-6ç§’éšæœºå»¶è¿Ÿ
4. **æ— è§„å¾‹** - å®Œå…¨éšæœºï¼Œéš¾ä»¥è¢«è¯†åˆ«

### ä¼˜åŠ¿

- âœ… æ›´åƒäººç±»è¡Œä¸º
- âœ… é™ä½è¢«æ£€æµ‹é£é™©
- âœ… è¯·æ±‚æ›´åˆ†æ•£
- âœ… æ›´å®‰å…¨ç¨³å®š

### é…ç½®å»ºè®®

| è§„æ¨¡ | äº§å“Ã—é—¨åº— | check_interval | é—´éš”èŒƒå›´ | é¢‘ç‡ |
|------|-----------|----------------|----------|------|
| å° | 2Ã—3=6 | 60ç§’ | 3-6ç§’ | 4æ¬¡/åˆ† âœ… |
| ä¸­ | 3Ã—4=12 | 90ç§’ | 4-7ç§’ | 7.7æ¬¡/åˆ† âœ… |
| å¤§ | 4Ã—5=20 | 150ç§’ | 5-8ç§’ | 9.2æ¬¡/åˆ† âœ… |

---

**è¿™ä¸ªç­–ç•¥æ˜¯ç›®å‰æœ€å®‰å…¨ã€æœ€æ™ºèƒ½çš„æ–¹æ¡ˆï¼** âœ…


