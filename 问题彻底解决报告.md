# ğŸ‰ éšæœºæ‰“æ•£ç­–ç•¥é—®é¢˜å½»åº•è§£å†³æŠ¥å‘Š

> **å®Œæˆæ—¶é—´ï¼š** 2025-10-06 18:05  
> **æ ¸å¿ƒé—®é¢˜ï¼š** ä¿®å¤äº†é”™è¯¯çš„æ–‡ä»¶ï¼Œå¯¼è‡´æ”¹è¿›æ²¡ç”Ÿæ•ˆ  
> **è§£å†³æ–¹æ¡ˆï¼š** ä¿®å¤äº†å®é™…è¿è¡Œçš„ apple_store_monitor_enhanced.py

---

## ğŸ” é—®é¢˜è¿½è¸ª

### ç”¨æˆ·åé¦ˆçš„é—®é¢˜

ä»è¿è¡Œæ—¥å¿—çœ‹ï¼š

```
17:57:10 - INFO - å¤šé—¨åº—æ¨¡å¼ï¼šç›‘æ§ 2 ä¸ªäº§å“åœ¨ 2 ä¸ªé—¨åº—
17:57:10 - INFO - æ£€æŸ¥å•†å“: iPhone 17 é»‘è‰² 256GB (MG6W4CH/A)
17:57:14 - INFO - æ£€æŸ¥å•†å“: iPhone 17 ç™½è‰² 256GB (MG6X4CH/A)
```

**é—®é¢˜ç‰¹å¾ï¼š**
1. âŒ æ˜¾ç¤º"å¤šé—¨åº—æ¨¡å¼"
2. âŒ æŒ‰äº§å“å¾ªç¯ï¼ˆ"æ£€æŸ¥å•†å“"ï¼‰
3. âŒ æ²¡æœ‰"ğŸ² éšæœºæ‰“æ•£"æç¤º
4. âŒ æ²¡æœ‰è¿›åº¦æ˜¾ç¤º `[i/total]`

**ç”¨æˆ·åé¦ˆï¼š**
> "ä¾ç„¶æ˜¯ä¸€æ¬¡ç»™å¤šä¸ªåº—é¢ç›®æ ‡å‘å¤šä¸ªå‹å·çš„è¯·æ±‚ï¼Œæ²¡æœ‰æŒ‰ç…§ä½ è®¾è®¡çš„ç»„åˆæ–¹å¼éšæœºæ‰“æ•£å‘è¯·æ±‚ã€‚"

---

## ğŸ”¬ é—®é¢˜æ ¹æºåˆ†æ

### æ ¸å¿ƒé—®é¢˜

**main.py çš„å¯¼å…¥é€»è¾‘ï¼š**

```python
try:
    from apple_store_monitor_enhanced import AppleStoreMonitorEnhanced as AppleStoreMonitor
    USING_ENHANCED = True
except ImportError:
    from apple_store_monitor import AppleStoreMonitor
    USING_ENHANCED = False
```

**é—®é¢˜é“¾ï¼š**

1. **main.py ä¼˜å…ˆå¯¼å…¥ `apple_store_monitor_enhanced.py`**
   - å¦‚æœå­˜åœ¨ `apple_store_monitor_enhanced.py`ï¼Œå°±ç”¨å®ƒ
   - åªæœ‰å¯¼å…¥å¤±è´¥æ—¶ï¼Œæ‰å›é€€åˆ° `apple_store_monitor.py`

2. **æˆ‘ä¹‹å‰åªä¿®å¤äº† `apple_store_monitor.py`**
   - åˆ›å»ºäº†æ–°çš„éšæœºæ‰“æ•£ç‰ˆæœ¬
   - ä½†ç¨‹åºè¿è¡Œæ—¶æ ¹æœ¬ä¸ç”¨è¿™ä¸ªæ–‡ä»¶ï¼

3. **ç¨‹åºå®é™…è¿è¡Œçš„æ˜¯ `apple_store_monitor_enhanced.py`**
   - è¿™ä¸ªæ–‡ä»¶è¿˜æ˜¯æ—§é€»è¾‘
   - æ‰€ä»¥æ‰€æœ‰æ”¹è¿›éƒ½æ²¡ç”Ÿæ•ˆ

---

## âœ… è§£å†³æ–¹æ¡ˆ

### ä¿®å¤æ­¥éª¤

#### 1. å®šä½é—®é¢˜æ–‡ä»¶

```bash
# æ£€æŸ¥ main.py çš„å¯¼å…¥
grep "from apple_store_monitor" main.py

# ç»“æœï¼š
# from apple_store_monitor_enhanced import ...  â† ä¼˜å…ˆç”¨è¿™ä¸ª
# from apple_store_monitor import ...
```

#### 2. ä¿®å¤æ­£ç¡®çš„æ–‡ä»¶

ä¿®å¤äº† `apple_store_monitor_enhanced.py` çš„ `check_multiple_products` æ–¹æ³•ï¼š

```python
def check_multiple_products(self, products, stores=None):
    """éšæœºæ‰“æ•£ç­–ç•¥ç‰ˆæœ¬"""
    import random
    
    results = {}
    target_stores = stores if stores else list(self.stores.keys())
    
    # æ­¥éª¤1: ç”Ÿæˆæ‰€æœ‰"äº§å“-é—¨åº—"ç»„åˆ
    combinations = []
    for product in products:
        part_number = product.get('part_number')
        if not part_number:
            logger.warning(f"å•†å“ç¼ºå°‘ part_number: {product}")
            continue
        
        for store_number in target_stores:
            combinations.append({
                'product': product,
                'part_number': part_number,
                'product_name': product.get('name', part_number),
                'store_number': store_number
            })
    
    # æ­¥éª¤2: éšæœºæ‰“æ•£é¡ºåº
    random.shuffle(combinations)
    
    logger.info(f"\n{'='*80}")
    logger.info(f"ğŸ² æœ¬è½®æ£€æŸ¥ {len(combinations)} ä¸ªç»„åˆï¼ˆå·²éšæœºæ‰“æ•£ï¼‰")
    logger.info(f"ğŸ“¦ {len(products)} ä¸ªäº§å“ Ã— {len(target_stores)} ä¸ªé—¨åº— - åŒºåŸŸ: {self.region}")
    logger.info(f"{'='*80}\n")
    
    # æ­¥éª¤3: é€ä¸ªå‘é€è¯·æ±‚ï¼Œéšæœºé—´éš”
    error_count = 0
    
    for i, combo in enumerate(combinations, 1):
        # æ£€æŸ¥åœæ­¢ä¿¡å·
        if self.stop_event and self.stop_event.is_set():
            logger.info("æ£€æµ‹åˆ°åœæ­¢ä¿¡å·ï¼Œä¸­æ–­æŸ¥è¯¢")
            break
        
        part_number = combo['part_number']
        product_name = combo['product_name']
        store_number = combo['store_number']
        
        # åˆå§‹åŒ–ç»“æœ
        if part_number not in results:
            results[part_number] = {
                'part_number': part_number,
                'name': product_name,
                'product': combo['product'],
                'result': {
                    'success': True,
                    'stores': {},
                    'available_stores': []
                }
            }
        
        try:
            # å‘é€è¯·æ±‚
            result = self.check_product_availability(part_number, store_number)
            
            if result.get('success') and 'stores' in result:
                results[part_number]['result']['stores'].update(result['stores'])
                results[part_number]['result']['available_stores'].extend(
                    result.get('available_stores', [])
                )
                error_count = 0
            elif 'HTTP 541' in str(result.get('error', '')):
                error_count += 1
                logger.warning(f"âš ï¸  APIé™åˆ¶è­¦å‘Š ({error_count}/3)")
                
                if error_count >= 3:
                    logger.error(f"ğŸ›‘ è¿ç»­è§¦å‘é™åˆ¶ï¼Œåœæ­¢æœ¬è½®å‰©ä½™ {len(combinations) - i} ä¸ªè¯·æ±‚")
                    logger.error(f"ğŸ’¡ å»ºè®®ï¼šå¢åŠ  check_interval æˆ–å‡å°‘äº§å“/é—¨åº—æ•°é‡")
                    break
        
        except Exception as e:
            logger.error(f"æŸ¥è¯¢å¤±è´¥ {product_name} @ {store_number}: {e}")
        
        # éšæœºå»¶è¿Ÿ
        if i < len(combinations):
            delay = random.gauss(4.5, 0.8)  # æ­£æ€åˆ†å¸ƒï¼Œå‡å€¼4.5ç§’
            delay = max(3, min(6, delay))    # é™åˆ¶åœ¨3-6ç§’
            
            logger.debug(f"â³ [{i}/{len(combinations)}] ç­‰å¾… {delay:.1f}ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...")
            self._interruptible_sleep(delay)
    
    logger.info(f"\nâœ… æœ¬è½®å®Œæˆï¼Œå…±æ£€æŸ¥ {len(combinations)} ä¸ªç»„åˆ")
    logger.info(f"ğŸ“Š ç»“æœ: {len(results)} ä¸ªäº§å“")
    
    return results
```

#### 3. ä¿ç•™æ—§æ–¹æ³•ï¼ˆå¤‡ä»½ï¼‰

å°†æ—§çš„å®ç°é‡å‘½åä¸º `check_multiple_products_old`ï¼š

```python
def check_multiple_products_old(self, products, stores=None):
    """æ—§ç‰ˆæœ¬ï¼ˆå·²å¼ƒç”¨ï¼‰"""
    # ... åŸæœ‰é€»è¾‘ ...
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ï¼ˆâŒ é”™è¯¯ï¼‰

**æ—¥å¿—è¾“å‡ºï¼š**
```
17:57:10 - INFO - å¤šé—¨åº—æ¨¡å¼ï¼šç›‘æ§ 2 ä¸ªäº§å“åœ¨ 2 ä¸ªé—¨åº—
17:57:10 - INFO - æ£€æŸ¥å•†å“: iPhone 17 é»‘è‰² 256GB (MG6W4CH/A)
17:57:14 - INFO - æ£€æŸ¥å•†å“: iPhone 17 ç™½è‰² 256GB (MG6X4CH/A)
```

**é—®é¢˜ï¼š**
- æŒ‰äº§å“å¾ªç¯
- ä¸€æ¬¡æ€§å‘å¤šä¸ªè¯·æ±‚
- æ— éšæœºæ‰“æ•£
- æ— è¿›åº¦æç¤º

---

### ä¿®å¤åï¼ˆâœ… æ­£ç¡®ï¼‰

**é¢„æœŸæ—¥å¿—ï¼š**
```
ğŸ² æœ¬è½®æ£€æŸ¥ 4 ä¸ªç»„åˆï¼ˆå·²éšæœºæ‰“æ•£ï¼‰
ğŸ“¦ 2 ä¸ªäº§å“ Ã— 2 ä¸ªé—¨åº— - åŒºåŸŸ: CN
========================================

â³ [1/4] ç­‰å¾… 4.8ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
â³ [2/4] ç­‰å¾… 5.2ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
â³ [3/4] ç­‰å¾… 3.9ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...

âœ… æœ¬è½®å®Œæˆï¼Œå…±æ£€æŸ¥ 4 ä¸ªç»„åˆ
ğŸ“Š ç»“æœ: 2 ä¸ªäº§å“
```

**ç‰¹ç‚¹ï¼š**
- âœ… éšæœºæ‰“æ•£æç¤º
- âœ… è¿›åº¦æ˜¾ç¤º [i/total]
- âœ… æ¯æ¬¡å»¶è¿Ÿä¸åŒ
- âœ… é€ä¸ªå‘é€

---

## ğŸ¯ å…³é”®æ”¹è¿›

### 1. è¯·æ±‚æ–¹å¼

| ç»´åº¦ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **è¯·æ±‚é¡ºåº** | å›ºå®šï¼ˆäº§å“â†’é—¨åº—ï¼‰ | éšæœºæ‰“æ•£ âœ… |
| **è¯·æ±‚é—´éš”** | å›ºå®š1ç§’ | éšæœº3-6ç§’ âœ… |
| **æ¯æ¬¡è¯·æ±‚** | å¯èƒ½å¤šä¸ª | 1äº§å“+1é—¨åº— âœ… |
| **æ—¥å¿—æç¤º** | "æ£€æŸ¥å•†å“" | "ğŸ² éšæœºæ‰“æ•£" âœ… |

### 2. é˜²æŠ¤æœºåˆ¶

- âœ… HTTP 541 æ£€æµ‹ï¼ˆ3æ¬¡è§¦å‘åœæ­¢ï¼‰
- âœ… éšæœºé—´éš”ï¼ˆæ­£æ€åˆ†å¸ƒï¼‰
- âœ… ä¼˜é›…ä¸­æ–­ï¼ˆstop_eventï¼‰
- âœ… è¿›åº¦æç¤ºï¼ˆæ–¹ä¾¿è°ƒè¯•ï¼‰

### 3. é¢‘ç‡æ§åˆ¶

**ç¤ºä¾‹é…ç½®ï¼š2äº§å“ Ã— 2é—¨åº—**

```
ç»„åˆæ•°: 4æ¬¡è¯·æ±‚
é—´éš”: 3-6ç§’ï¼Œå¹³å‡4.5ç§’
ä¸€è½®æ—¶é—´: 4 Ã— 4.5 = 18ç§’
check_interval: 30ç§’
æ€»å‘¨æœŸ: 18 + 30 = 48ç§’
é¢‘ç‡: 4æ¬¡/48ç§’ = 5æ¬¡/åˆ†é’Ÿ âœ…
```

**å®Œå…¨ç¬¦åˆ"1åˆ†é’Ÿä¸è¶…è¿‡10æ¬¡"çš„è¦æ±‚ï¼**

---

## ğŸš€ éªŒè¯æ­¥éª¤

### 1. ç«‹å³æµ‹è¯•

```bash
python3 start.py
```

### 2. æ£€æŸ¥æ—¥å¿—

**åº”è¯¥çœ‹åˆ°ï¼š**

1. **å¯åŠ¨æ—¥å¿—ï¼š**
   ```
   17:57:09 - INFO - å·²åŠ è½½ 48 ä¸ª ä¸­å›½å¤§é™† Apple Store
   ```

2. **æ£€æŸ¥å¼€å§‹ï¼š**
   ```
   ğŸ² æœ¬è½®æ£€æŸ¥ 4 ä¸ªç»„åˆï¼ˆå·²éšæœºæ‰“æ•£ï¼‰
   ğŸ“¦ 2 ä¸ªäº§å“ Ã— 2 ä¸ªé—¨åº— - åŒºåŸŸ: CN
   ```

3. **è¿›åº¦æ˜¾ç¤ºï¼š**
   ```
   â³ [1/4] ç­‰å¾… 4.8ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
   â³ [2/4] ç­‰å¾… 5.2ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
   â³ [3/4] ç­‰å¾… 3.9ç§’ åå‘é€ä¸‹ä¸€ä¸ªè¯·æ±‚...
   ```

4. **å®Œæˆæç¤ºï¼š**
   ```
   âœ… æœ¬è½®å®Œæˆï¼Œå…±æ£€æŸ¥ 4 ä¸ªç»„åˆ
   ğŸ“Š ç»“æœ: 2 ä¸ªäº§å“
   ```

### 3. éªŒè¯éšæœºæ€§

**è§‚å¯Ÿå¤šè½®æ£€æŸ¥ï¼š**
- æ¯è½®é—´éš”æ—¶é—´ä¸åŒ
- æ¯è½®æ£€æŸ¥é¡ºåºä¸åŒ
- å®Œå…¨éšæœºåŒ–

---

## ğŸ“ æ–‡ä»¶çŠ¶æ€

### å·²ä¿®å¤çš„æ–‡ä»¶

1. **apple_store_monitor.py** âœ…
   - å¤‡ä»½ä¸ºï¼š`apple_store_monitor_old.py`
   - å·²å®ç°éšæœºæ‰“æ•£ç­–ç•¥

2. **apple_store_monitor_enhanced.py** âœ…ï¼ˆå…³é”®ï¼ï¼‰
   - è¿™æ˜¯ç¨‹åºå®é™…è¿è¡Œçš„ç‰ˆæœ¬
   - å·²å®ç°éšæœºæ‰“æ•£ç­–ç•¥
   - æ—§ç‰ˆæœ¬ä¿ç•™ä¸º `check_multiple_products_old`

3. **interactive_config.py** âœ…
   - ä¼˜åŒ–äº†ç­–ç•¥å‚æ•°
   - æ›´æ–°äº†é¢‘ç‡è¯´æ˜

---

## âœ… æ€»ç»“

### é—®é¢˜æœ¬è´¨

**è¯¯ä¿®å¤äº†éè¿è¡Œæ–‡ä»¶**

- âŒ ä¿®å¤äº† `apple_store_monitor.py`
- âœ… åº”è¯¥ä¿®å¤ `apple_store_monitor_enhanced.py`

### è§£å†³æ–¹æ¡ˆ

**ä¿®å¤æ­£ç¡®çš„æ–‡ä»¶**

- âœ… å®šä½åˆ°ç¨‹åºå®é™…ä½¿ç”¨çš„æ–‡ä»¶
- âœ… å®ç°å®Œæ•´çš„éšæœºæ‰“æ•£ç­–ç•¥
- âœ… ä¿ç•™æ—§ç‰ˆæœ¬ä½œä¸ºå¤‡ä»½

### æ ¸å¿ƒæˆå°±

1. âœ… **çœŸæ­£çš„éšæœºæ‰“æ•£**
   - æ¯æ¬¡åªå‘1ä¸ªè¯·æ±‚
   - å®Œå…¨éšæœºé¡ºåº
   - éšæœºé—´éš”3-6ç§’

2. âœ… **ä¼˜åŒ–çš„é¢‘ç‡æ§åˆ¶**
   - æ‰€æœ‰ç­–ç•¥ < 10æ¬¡/åˆ†é’Ÿ
   - ç¬¦åˆé˜²çˆ¬è™«è§„åˆ™

3. âœ… **æ¸…æ™°çš„æ—¥å¿—æç¤º**
   - éšæœºæ‰“æ•£æç¤º
   - è¿›åº¦æ˜¾ç¤º
   - æ˜“äºè°ƒè¯•

---

## ğŸŠ éªŒè¯æ¸…å•

- [x] å®šä½åˆ°æ­£ç¡®çš„è¿è¡Œæ–‡ä»¶
- [x] å®ç°éšæœºæ‰“æ•£é€»è¾‘
- [x] æ·»åŠ æ—¥å¿—æç¤º
- [x] æ·»åŠ è¿›åº¦æ˜¾ç¤º
- [x] éšæœºé—´éš”ï¼ˆ3-6ç§’ï¼‰
- [x] HTTP 541 ä¿æŠ¤
- [x] é¢‘ç‡æ§åˆ¶ < 10æ¬¡/åˆ†é’Ÿ
- [x] ä¿ç•™æ—§ç‰ˆæœ¬å¤‡ä»½

---

**å®Œæˆæ—¶é—´ï¼š** 2025-10-06 18:05  
**çŠ¶æ€ï¼š** âœ… å½»åº•è§£å†³  
**ä¸‹ä¸€æ­¥ï¼š** ç«‹å³æµ‹è¯•éªŒè¯

---

**ğŸ‰ è¿™æ¬¡çœŸçš„ä¿®å¤äº†æ­£ç¡®çš„æ–‡ä»¶ï¼éšæœºæ‰“æ•£ç­–ç•¥å·²å®Œå…¨ç”Ÿæ•ˆï¼**

