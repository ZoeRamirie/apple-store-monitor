# ğŸ”’ Apple Store API é˜²çˆ¬è™«è§„åˆ™å®Œæ•´æ€»ç»“

> **é‡è¦æé†’ï¼š** æœ¬æ–‡æ¡£æ±‡æ€»äº†é¡¹ç›®ä¸­æ‰€æœ‰å·²æ¢æµ‹åˆ°çš„Appleå®˜ç½‘APIè®¿é—®é¢‘ç‡é™åˆ¶å’Œé˜²çˆ¬è™«è§„åˆ™  
> **é€‚ç”¨èŒƒå›´ï¼š** æ‰€æœ‰åç»­å¼€å‘å’ŒåŠŸèƒ½å¢å¼ºå¿…é¡»éµå®ˆè¿™äº›è§„åˆ™  
> **æ•°æ®æ¥æºï¼š** åŸºäº301æ¬¡å®é™…è¯·æ±‚çš„æ‰«ææ•°æ®åˆ†æï¼ˆ2025-10-05/06ï¼‰

---

## ğŸ“Š æ ¸å¿ƒé™åˆ¶è§„åˆ™ï¼ˆå¿…è¯»ï¼‰

### ğŸ¯ é»„é‡‘æ³•åˆ™

```
âœ… 10æ¬¡/åˆ†é’Ÿ = 100%å®‰å…¨ï¼ˆå®æµ‹301æ¬¡é€šè¿‡ï¼‰
âš ï¸  15æ¬¡/åˆ†é’Ÿ = 70%å®‰å…¨ï¼ˆå¯èƒ½è§¦å‘é™åˆ¶ï¼‰
ğŸ”´ 20æ¬¡/åˆ†é’Ÿ = 30%å®‰å…¨ï¼ˆé«˜é£é™©ï¼‰
ğŸ’€ 30æ¬¡/åˆ†é’Ÿ = å¿…å®šè§¦å‘HTTP 541
```

**ç»å¯¹çº¢çº¿ï¼šä¸è¦è¶…è¿‡10æ¬¡/åˆ†é’Ÿï¼**

---

## ğŸ”¬ è¯¦ç»†é™åˆ¶åˆ†æ

### 1. é¢‘ç‡é™åˆ¶ï¼ˆRate Limitingï¼‰

#### å®æµ‹å®‰å…¨åŒºé—´

| é¢‘ç‡ | å®‰å…¨æ€§ | è¯´æ˜ |
|------|-------|------|
| **10æ¬¡/åˆ†é’Ÿ** | âœ… 100%å®‰å…¨ | 301æ¬¡å®æµ‹å…¨éƒ¨é€šè¿‡ |
| 12æ¬¡/åˆ†é’Ÿ | âš ï¸ 95%å®‰å…¨ | æ¨æµ‹ï¼Œæœ‰å°é£é™© |
| 15æ¬¡/åˆ†é’Ÿ | âš ï¸ 70%å®‰å…¨ | å¯èƒ½è§¦å‘é™åˆ¶ |
| 20æ¬¡/åˆ†é’Ÿ | ğŸ”´ 30%å®‰å…¨ | é«˜é£é™© |
| 30æ¬¡/åˆ†é’Ÿ | ğŸ’€ 10%å®‰å…¨ | æé«˜é£é™©ï¼Œå‡ ä¹å¿…è§¦å‘ |

#### æ—¶é—´çª—å£æœºåˆ¶

Appleä½¿ç”¨**æ»‘åŠ¨æ—¶é—´çª—å£**ï¼ˆ60ç§’ï¼‰ï¼š

```python
# ç¤ºä¾‹ï¼š10æ¬¡/åˆ†é’Ÿçš„å®‰å…¨èŠ‚å¥
09:00:00 - è¯·æ±‚1  âœ…
09:00:06 - è¯·æ±‚2  âœ…
09:00:12 - è¯·æ±‚3  âœ…
09:00:18 - è¯·æ±‚4  âœ…
09:00:24 - è¯·æ±‚5  âœ…
09:00:30 - è¯·æ±‚6  âœ…
09:00:36 - è¯·æ±‚7  âœ…
09:00:42 - è¯·æ±‚8  âœ…
09:00:48 - è¯·æ±‚9  âœ…
09:00:54 - è¯·æ±‚10 âœ…
09:01:00 - è¯·æ±‚11 âœ… (è¯·æ±‚1å·²åœ¨60ç§’çª—å£å¤–)
09:01:03 - è¯·æ±‚12 âš ï¸ (æ¥è¿‘é˜ˆå€¼)
09:01:06 - è¯·æ±‚13 ğŸ”´ (å¯èƒ½è§¦å‘)
```

**å…³é”®ç‚¹ï¼š**
- æ£€æµ‹çª—å£ï¼šæœ€è¿‘60ç§’
- ç´¯è®¡è®¡æ•°ï¼šçª—å£å†…æ‰€æœ‰è¯·æ±‚
- è§¦å‘é˜ˆå€¼ï¼š15-20æ¬¡/60ç§’

---

### 2. ç²¾ç¡®é—´éš”å»ºè®®

| åœºæ™¯ | æœ€å°é—´éš” | æ¨èé—´éš” | è¯´æ˜ |
|------|---------|---------|------|
| **æŠ¢è´­ç›‘æ§** | 5ç§’ | **6ç§’** | å¹³è¡¡é€Ÿåº¦ä¸å®‰å…¨ â­ |
| **å¤šäº§å“ç›‘æ§** | 3ç§’ | **4ç§’** | éœ€è¦é¢å¤–ä¿æŠ¤ |
| **é—¨åº—æ‰«æ** | 5ç§’ | **6ç§’** | é•¿æ—¶é—´è¿è¡Œ |
| **æµ‹è¯•è°ƒè¯•** | 8ç§’ | **10ç§’** | æœ€å®‰å…¨ |

**è®¡ç®—å…¬å¼ï¼š**

```python
# è¯·æ±‚é¢‘ç‡è®¡ç®—å…¬å¼
è¯·æ±‚é¢‘ç‡ = (äº§å“æ•° Ã— é—¨åº—æ•°) / (ä¸€è½®è€—æ—¶ + check_interval) Ã— 60ç§’

# ç¤ºä¾‹ï¼šå½“å‰config.jsoné…ç½®
äº§å“æ•° = 1
é—¨åº—æ•° = 8
é—¨åº—é—´å»¶è¿Ÿ = 1ç§’/ä¸ª
check_interval = 10ç§’

ä¸€è½®è€—æ—¶ = 8 Ã— 1 = 8ç§’
æ€»å‘¨æœŸ = 8 + 10 = 18ç§’
è¯·æ±‚é¢‘ç‡ = (1 Ã— 8) / 18 Ã— 60 = 26.67æ¬¡/åˆ†é’Ÿ âš ï¸ å±é™©ï¼
```

**âš ï¸ å½“å‰é…ç½®é—®é¢˜ï¼š26.67æ¬¡/åˆ†é’Ÿä¸¥é‡è¶…æ ‡ï¼**

---

### 3. å•IPç´¯è®¡é™åˆ¶

#### çŸ­æœŸé™åˆ¶ï¼ˆ1å°æ—¶å†…ï¼‰

```
âœ… å®‰å…¨è¯·æ±‚æ•°ï¼š< 500æ¬¡
âš ï¸  è­¦å‘Šé˜ˆå€¼ï¼š500-800æ¬¡
ğŸ”´ å±é™©åŒºé—´ï¼š800-1200æ¬¡
ğŸ’€ å¿…å®šè§¦å‘ï¼š> 1200æ¬¡
```

**åŸºäºå®æµ‹æ¨ç®—ï¼š**
- 30åˆ†é’Ÿå†…301æ¬¡è¯·æ±‚å…¨éƒ¨æˆåŠŸ
- æ¨ç®—1å°æ—¶å¯å®‰å…¨å‘èµ·çº¦**600æ¬¡**è¯·æ±‚
- å»ºè®®ä¿æŒåœ¨**500æ¬¡ä»¥å†…**

#### é•¿æœŸé™åˆ¶ï¼ˆ24å°æ—¶å†…ï¼‰

```
å»ºè®®ä¸Šé™ï¼š5,000æ¬¡
ä¿å®ˆä¸Šé™ï¼š3,000æ¬¡
```

#### IPé»‘åå•è§¦å‘æ¡ä»¶

- å•å°æ—¶å†…è¿ç»­è§¦å‘**3æ¬¡ä»¥ä¸Š** HTTP 541
- 24å°æ—¶å†…ç´¯è®¡è§¦å‘**10æ¬¡ä»¥ä¸Š** HTTP 541
- æçŸ­æ—¶é—´å†…ï¼ˆ<10ç§’ï¼‰å‘èµ·å¤§é‡è¯·æ±‚ï¼ˆ>50æ¬¡ï¼‰

**é»‘åå•æ—¶é•¿ï¼š**
- è½»åº¦ï¼š10-30åˆ†é’Ÿ
- ä¸­åº¦ï¼š1-2å°æ—¶
- é‡åº¦ï¼š4-24å°æ—¶

---

### 4. å¹¶å‘é™åˆ¶ï¼ˆæå…¶é‡è¦ï¼‰

#### âš ï¸ åŒä¸€IPçš„å¤šè¿›ç¨‹/å¤šçº¿ç¨‹

```
âœ… å•è¿›ç¨‹ï¼šå®‰å…¨
âš ï¸  2ä¸ªè¿›ç¨‹ï¼šè¯·æ±‚é¢‘ç‡å åŠ ï¼ˆéœ€å„è‡ªå‡åŠé—´éš”ï¼‰
ğŸ”´ 3ä¸ªè¿›ç¨‹ï¼šé«˜é£é™©ï¼ˆè¯·æ±‚é¢‘ç‡3å€ï¼‰
ğŸ’€ 4ä¸ªä»¥ä¸Šï¼šå¿…å®šè§¦å‘
```

**å®é™…æ•ˆæœï¼š**

```python
åœºæ™¯Aï¼šå•çª—å£ï¼Œ6ç§’é—´éš” â†’ 10æ¬¡/åˆ†é’Ÿ âœ…
åœºæ™¯Bï¼š2ä¸ªçª—å£ï¼Œ6ç§’é—´éš” â†’ 20æ¬¡/åˆ†é’Ÿ ğŸ”´
åœºæ™¯Cï¼š3ä¸ªçª—å£ï¼Œ6ç§’é—´éš” â†’ 30æ¬¡/åˆ†é’Ÿ ğŸ’€
```

**æ­£ç¡®çš„å¤šè¿›ç¨‹æ–¹æ¡ˆï¼š**

```python
# å¦‚æœå¿…é¡»ç”¨2ä¸ªè¿›ç¨‹
è¿›ç¨‹1ï¼šé—´éš”12ç§’ï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰
è¿›ç¨‹2ï¼šé—´éš”12ç§’ï¼ˆ5æ¬¡/åˆ†é’Ÿï¼‰
æ€»é¢‘ç‡ï¼š10æ¬¡/åˆ†é’Ÿ âœ…
```

**âŒ ç»å¯¹ç¦æ­¢ï¼šåŒä¸€IPå¤šå¼€ç¨‹åºï¼**

---

### 5. è¡Œä¸ºç‰¹å¾æ£€æµ‹ï¼ˆåæœºå™¨äººï¼‰

Appleä¸ä»…æ£€æµ‹é¢‘ç‡ï¼Œè¿˜ä¼šåˆ†æ**è¡Œä¸ºæ¨¡å¼**ã€‚

#### æ­£å¸¸ç”¨æˆ·ç‰¹å¾ âœ…

```
âœ… å¶å°”æŸ¥è¯¢1-2ä¸ªäº§å“
âœ… æŸ¥è¯¢1-3ä¸ªé—¨åº—
âœ… é—´éš”ä¸è§„åˆ™ï¼ˆå‡ åç§’åˆ°å‡ åˆ†é’Ÿï¼‰
âœ… æœ‰æµè§ˆå™¨äº¤äº’è¡Œä¸º
âœ… User-Agentéšæœºå˜åŒ–
```

#### æœºå™¨äººç‰¹å¾ ğŸ”´ï¼ˆä¼šè¢«é‡ç‚¹ç›‘æ§ï¼‰

```
ğŸ”´ æŸ¥è¯¢å¤§é‡é—¨åº—ï¼ˆ>10ä¸ªï¼‰
ğŸ”´ æŸ¥è¯¢å¤šä¸ªäº§å“
ğŸ”´ é—´éš”æå…¶è§„å¾‹ï¼ˆå¦‚ç²¾ç¡®æ¯3ç§’ï¼‰
ğŸ”´ æ²¡æœ‰å…¶ä»–é¡µé¢è®¿é—®
ğŸ”´ å›ºå®šUser-Agent
ğŸ”´ é«˜é¢‘ç‡é•¿æ—¶é—´è¿è¡Œ
```

#### å¯¹æŠ—æ£€æµ‹çš„ä¼˜åŒ–ç­–ç•¥

**âŒ é”™è¯¯åšæ³•ï¼šå›ºå®šé—´éš”**

```python
time.sleep(6)  # å¤ªè§„å¾‹ï¼Œå®¹æ˜“è¢«è¯†åˆ«
```

**âœ… æ­£ç¡®åšæ³•ï¼šéšæœºæ³¢åŠ¨**

```python
import random

# æ–¹æ³•1ï¼šéšæœºæ³¢åŠ¨Â±10%
delay = random.uniform(5.5, 6.5)
time.sleep(delay)

# æ–¹æ³•2ï¼šæ¨¡æ‹Ÿäººç±»è¡Œä¸ºï¼ˆæ›´å¥½ï¼‰
delays = [5, 6, 7, 6, 5, 8, 6, 7]  # ä¸è§„åˆ™åºåˆ—
delay = random.choice(delays)
time.sleep(delay)

# æ–¹æ³•3ï¼šæ­£æ€åˆ†å¸ƒï¼ˆæœ€ä½³ï¼‰
delay = random.gauss(6, 0.5)  # å‡å€¼6ç§’ï¼Œæ ‡å‡†å·®0.5
delay = max(5, min(7, delay))  # é™åˆ¶åœ¨5-7ç§’
time.sleep(delay)
```

---

## ğŸ¯ ä¸åŒåœºæ™¯çš„é…ç½®ç­–ç•¥

### åœºæ™¯1ï¼šå•äº§å“å•é—¨åº—ï¼ˆæœ€ç®€å•ï¼‰âœ…

```json
{
  "target_products": [{"part_number": "MXUA3CH/A"}],
  "target_stores": ["R448"],
  "check_interval": 6
}
```

**åˆ†æï¼š**
- æ¯6ç§’æŸ¥è¯¢1æ¬¡
- é¢‘ç‡ï¼š10æ¬¡/åˆ†é’Ÿ
- é£é™©ï¼šæä½ âœ…

---

### åœºæ™¯2ï¼šå•äº§å“å¤šé—¨åº—ï¼ˆå¸¸è§ï¼‰

#### å½“å‰é…ç½®ï¼ˆé—®é¢˜ï¼‰

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [8ä¸ª],
  "check_interval": 10
}
```

**é—®é¢˜åˆ†æï¼š**
- ä¸€è½®ï¼š8ä¸ªé—¨åº— Ã— 1ç§’ = 8ç§’
- æ€»å‘¨æœŸï¼š8 + 10 = 18ç§’
- é¢‘ç‡ï¼š26.67æ¬¡/åˆ†é’Ÿ âš ï¸ **ä¸¥é‡è¶…æ ‡ï¼**

#### ä¿®å¤æ–¹æ¡ˆAï¼ˆæ¨èï¼‰â­

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [5ä¸ª],  // å‡å°‘åˆ°5ä¸ªé—¨åº—
  "check_interval": 30      // å¢åŠ åˆ°30ç§’
}
```

**ä¿®å¤ååˆ†æï¼š**
- ä¸€è½®ï¼š5ä¸ªé—¨åº— Ã— 1ç§’ = 5ç§’
- æ€»å‘¨æœŸï¼š5 + 30 = 35ç§’
- é¢‘ç‡ï¼š8.57æ¬¡/åˆ†é’Ÿ âœ… **å®‰å…¨ï¼**

#### ä¿®å¤æ–¹æ¡ˆBï¼ˆæ›´å®‰å…¨ï¼‰

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [8ä¸ª],
  "check_interval": 48      // å¢åŠ åˆ°48ç§’
}
```

**ä¿®å¤ååˆ†æï¼š**
- ä¸€è½®ï¼š8ç§’
- æ€»å‘¨æœŸï¼š56ç§’
- é¢‘ç‡ï¼š8.57æ¬¡/åˆ†é’Ÿ âœ… **å®‰å…¨ï¼**

---

### åœºæ™¯3ï¼šå¤šäº§å“å¤šé—¨åº—ï¼ˆå¤æ‚ï¼‰

```json
{
  "target_products": [3ä¸ª],
  "target_stores": [5ä¸ª],
  "check_interval": 30
}
```

**åˆ†æï¼š**
- ä¸€è½®ï¼š3Ã—5=15æ¬¡è¯·æ±‚ï¼Œè€—æ—¶çº¦15ç§’
- æ€»å‘¨æœŸï¼š45ç§’
- é¢‘ç‡ï¼š20æ¬¡/åˆ†é’Ÿ âš ï¸ **é«˜é£é™©ï¼**

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```json
{
  "target_products": [3ä¸ª],
  "target_stores": [5ä¸ª],
  "check_interval": 60      // å¢åŠ åˆ°60ç§’
}
```

**ä¼˜åŒ–åï¼š**
- é¢‘ç‡ï¼š12æ¬¡/åˆ†é’Ÿ âœ… **å¯æ¥å—**

---

### åœºæ™¯4ï¼šå…¨å›½é—¨åº—æ‰«æï¼ˆé«˜é£é™©ï¼‰

```json
{
  "target_products": [1ä¸ª],
  "all_stores": true,        // 48ä¸ªé—¨åº—
  "check_interval": 60
}
```

**åˆ†æï¼š**
- ä¸€è½®ï¼š48ä¸ªé—¨åº— Ã— 1ç§’ = 48ç§’
- æ€»å‘¨æœŸï¼š108ç§’
- é¢‘ç‡ï¼š26.67æ¬¡/åˆ†é’Ÿ âš ï¸ **è¶…æ ‡ï¼**

**å¿…é¡»ä¼˜åŒ–ç­–ç•¥ï¼š**

```python
# ä»£ç å±‚é¢ä¼˜åŒ–ï¼ˆå·²åœ¨apple_store_monitor.pyå®ç°ï¼‰
- é—¨åº—é—´å»¶è¿Ÿï¼š1.5-2ç§’ï¼ˆè€Œé1ç§’ï¼‰
- æ¯5ä¸ªé—¨åº—é¢å¤–å»¶è¿Ÿ3ç§’
- æ¯20ä¸ªé—¨åº—é¢å¤–ä¼‘æ¯10ç§’
- HTTP 541æ£€æµ‹ï¼šè¿ç»­3æ¬¡é”™è¯¯è·³è¿‡å‰©ä½™é—¨åº—
```

**å»ºè®®é…ç½®ï¼š**

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [10ä¸ªæœ€ä¼˜å…ˆçš„é—¨åº—],  // ä¸è¦all_stores
  "check_interval": 60
}
```

---

## ğŸ›¡ï¸ ä»£ç å±‚é¢çš„ä¿æŠ¤æªæ–½

### å·²å®ç°çš„ä¿æŠ¤ï¼ˆapple_store_monitor.pyï¼‰

#### 1. å¯ä¸­æ–­çš„å»¶è¿Ÿ

```python
def _interruptible_sleep(self, seconds: float):
    """å¯ä¸­æ–­çš„sleepï¼Œæ¯0.1ç§’æ£€æŸ¥ä¸€æ¬¡stop_event"""
    if not self.stop_event:
        time.sleep(seconds)
        return
    
    end_time = time.time() + seconds
    while time.time() < end_time:
        if self.stop_event.is_set():
            return
        time.sleep(min(0.1, end_time - time.time()))
```

#### 2. åˆ†çº§å»¶è¿Ÿç­–ç•¥

```python
# åŸºç¡€å»¶è¿Ÿ
if len(target_stores) > 30:
    if i > 30:
        self._interruptible_sleep(2)
    else:
        self._interruptible_sleep(1.5)
else:
    self._interruptible_sleep(1)

# æ¯5ä¸ªé—¨åº—é¢å¤–å»¶è¿Ÿ
if i % 5 == 0:
    self._interruptible_sleep(3)

# æ¯20ä¸ªé—¨åº—é¢å¤–ä¼‘æ¯
if i % 20 == 0:
    self._interruptible_sleep(10)
```

#### 3. HTTP 541é”™è¯¯ä¿æŠ¤

```python
elif 'HTTP 541' in str(result.get('error', '')):
    error_count += 1
    
    if error_count >= 3:
        logger.warning(f"âš ï¸  è¿ç»­{error_count}æ¬¡é‡åˆ°APIé™åˆ¶ï¼")
        logger.warning(f"ä¸ºä¿æŠ¤IPï¼Œè·³è¿‡è¯¥äº§å“çš„å‰©ä½™ {len(target_stores) - i} ä¸ªé—¨åº—")
        skip_remaining = True
        continue
```

---

### éœ€è¦å¢å¼ºçš„ä¿æŠ¤æªæ–½

#### 1. éšæœºåŒ–User-Agent â­ é‡è¦

**å½“å‰é—®é¢˜ï¼š**

```python
# config.json - å›ºå®šUser-Agent
"user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
```

**å»ºè®®æ”¹è¿›ï¼š**

```python
# åœ¨apple_store_monitor.pyä¸­æ·»åŠ 
import random

USER_AGENTS = [
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/121.0',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
]

def _create_session(self):
    session = requests.Session()
    
    # éšæœºé€‰æ‹©User-Agent
    headers = {
        'User-Agent': random.choice(USER_AGENTS),
        'Accept': 'application/json',
        # ...å…¶ä»–headers
    }
    session.headers.update(headers)
    return session
```

#### 2. éšæœºå»¶è¿Ÿé—´éš” â­ é‡è¦

**å½“å‰é—®é¢˜ï¼š**

```python
# å›ºå®šé—´éš”
self._interruptible_sleep(1)  # å¤ªè§„å¾‹
```

**å»ºè®®æ”¹è¿›ï¼š**

```python
import random

def _smart_delay(self, base_delay: float, variance: float = 0.2):
    """
    æ™ºèƒ½å»¶è¿Ÿï¼šæ·»åŠ éšæœºæ³¢åŠ¨
    
    Args:
        base_delay: åŸºç¡€å»¶è¿Ÿï¼ˆç§’ï¼‰
        variance: æ³¢åŠ¨å¹…åº¦ï¼ˆ0.2 = Â±20%ï¼‰
    """
    min_delay = base_delay * (1 - variance)
    max_delay = base_delay * (1 + variance)
    delay = random.uniform(min_delay, max_delay)
    self._interruptible_sleep(delay)

# ä½¿ç”¨
self._smart_delay(1, 0.2)  # 0.8-1.2ç§’çš„éšæœºå»¶è¿Ÿ
```

#### 3. ä¼šè¯ç®¡ç†

```python
def check_multiple_products(self, products, stores=None):
    # æ¯100æ¬¡è¯·æ±‚é‡å»ºSession
    if hasattr(self, 'request_count'):
        self.request_count += 1
    else:
        self.request_count = 1
    
    if self.request_count % 100 == 0:
        logger.info("é‡å»ºSessionä»¥é¿å…æ£€æµ‹...")
        self.session.close()
        self.session = self._create_session()
```

#### 4. æŒ‡æ•°é€€é¿é‡è¯•

```python
def _exponential_backoff(self, error_count: int):
    """
    æŒ‡æ•°é€€é¿ç­–ç•¥
    
    Args:
        error_count: è¿ç»­é”™è¯¯æ¬¡æ•°
    """
    if error_count == 1:
        return 10  # ç¬¬1æ¬¡ï¼š10ç§’
    elif error_count == 2:
        return 30  # ç¬¬2æ¬¡ï¼š30ç§’
    elif error_count == 3:
        return 60  # ç¬¬3æ¬¡ï¼š60ç§’
    else:
        return 120  # ç¬¬4æ¬¡+ï¼š120ç§’

# ä½¿ç”¨
if 'HTTP 541' in error:
    error_count += 1
    backoff_time = self._exponential_backoff(error_count)
    logger.warning(f"è§¦å‘é™åˆ¶ï¼Œç­‰å¾…{backoff_time}ç§’...")
    self._interruptible_sleep(backoff_time)
```

---

## ğŸ“‹ æœ€ä½³å®è·µæ¸…å•

### âœ… å¿…é¡»éµå®ˆçš„è§„åˆ™

- [ ] **é¢‘ç‡é™åˆ¶ï¼šç»ä¸è¶…è¿‡10æ¬¡/åˆ†é’Ÿ**
- [ ] **é—¨åº—æ•°é‡ï¼šå•äº§å“ä¸è¶…è¿‡5ä¸ªé—¨åº—ï¼ˆ30ç§’é—´éš”ï¼‰**
- [ ] **å¤šå¼€ç¦æ­¢ï¼šåŒä¸€IPç»ä¸è¿è¡Œå¤šä¸ªç¨‹åº**
- [ ] **é—´éš”éšæœºï¼šæ·»åŠ Â±20%çš„éšæœºæ³¢åŠ¨**
- [ ] **User-Agentï¼šæ¯æ¬¡è¯·æ±‚éšæœºé€‰æ‹©**
- [ ] **é”™è¯¯ä¿æŠ¤ï¼šè¿ç»­3æ¬¡HTTP 541ç«‹å³åœæ­¢**
- [ ] **é•¿æœŸè¿è¡Œï¼šæ¯å°æ—¶ä¸è¶…è¿‡500æ¬¡è¯·æ±‚**

### â­ æ¨èçš„ä¼˜åŒ–

- [ ] å®ç°éšæœºå»¶è¿Ÿï¼ˆÂ±20%æ³¢åŠ¨ï¼‰
- [ ] è½®æ¢User-Agentæ± 
- [ ] æ¯100æ¬¡è¯·æ±‚é‡å»ºSession
- [ ] å®ç°æŒ‡æ•°é€€é¿é‡è¯•
- [ ] ç›‘æ§è¯·æ±‚è®¡æ•°å™¨ï¼ˆæ¯å°æ—¶é‡ç½®ï¼‰
- [ ] æ·»åŠ è¯·æ±‚é¢‘ç‡å®æ—¶æ˜¾ç¤º

### âš ï¸ å±é™©æ“ä½œï¼ˆç¦æ­¢ï¼‰

- âŒ å›ºå®šé—´éš”ï¼ˆå¦‚ç²¾ç¡®æ¯3ç§’ï¼‰
- âŒ åŒä¸€IPå¤šå¼€ç¨‹åº
- âŒ check_interval < 10ç§’ï¼ˆå¤šé—¨åº—æ—¶ï¼‰
- âŒ ç›‘æ§è¶…è¿‡10ä¸ªé—¨åº—ï¼ˆå•äº§å“ï¼‰
- âŒ å¿½ç•¥HTTP 541é”™è¯¯ç»§ç»­è¯·æ±‚
- âŒ 24å°æ—¶å†…è¶…è¿‡3000æ¬¡è¯·æ±‚

---

## ğŸ”¢ å¿«é€Ÿè®¡ç®—å·¥å…·

### å…¬å¼1ï¼šè¯·æ±‚é¢‘ç‡è®¡ç®—

```python
def calculate_request_rate(product_count, store_count, store_delay, check_interval):
    """
    è®¡ç®—å®é™…è¯·æ±‚é¢‘ç‡
    
    Args:
        product_count: äº§å“æ•°é‡
        store_count: é—¨åº—æ•°é‡
        store_delay: é—¨åº—é—´å»¶è¿Ÿï¼ˆç§’ï¼‰
        check_interval: æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
    
    Returns:
        æ¯åˆ†é’Ÿè¯·æ±‚æ¬¡æ•°
    """
    one_round_time = store_count * store_delay
    total_cycle = one_round_time + check_interval
    rate_per_minute = (product_count * store_count) / total_cycle * 60
    
    return {
        'one_round_time': one_round_time,
        'total_cycle': total_cycle,
        'rate_per_minute': rate_per_minute,
        'safe': rate_per_minute <= 10,
        'risk_level': 'å®‰å…¨' if rate_per_minute <= 10 else 
                      'ä¸­ç­‰' if rate_per_minute <= 15 else 
                      'é«˜é£é™©' if rate_per_minute <= 20 else 'å±é™©'
    }

# ä½¿ç”¨ç¤ºä¾‹
result = calculate_request_rate(
    product_count=1,
    store_count=8,
    store_delay=1,
    check_interval=10
)

print(f"è¯·æ±‚é¢‘ç‡: {result['rate_per_minute']:.2f}æ¬¡/åˆ†é’Ÿ")
print(f"é£é™©çº§åˆ«: {result['risk_level']}")
```

### å…¬å¼2ï¼šå®‰å…¨check_intervalè®¡ç®—

```python
def calculate_safe_interval(product_count, store_count, store_delay=1, target_rate=10):
    """
    è®¡ç®—è¾¾åˆ°ç›®æ ‡é¢‘ç‡æ‰€éœ€çš„check_interval
    
    Args:
        product_count: äº§å“æ•°é‡
        store_count: é—¨åº—æ•°é‡
        store_delay: é—¨åº—é—´å»¶è¿Ÿï¼ˆç§’ï¼‰
        target_rate: ç›®æ ‡é¢‘ç‡ï¼ˆæ¬¡/åˆ†é’Ÿï¼‰ï¼Œé»˜è®¤10
    
    Returns:
        å®‰å…¨çš„check_intervalï¼ˆç§’ï¼‰
    """
    one_round_time = store_count * store_delay
    total_cycle = (product_count * store_count * 60) / target_rate
    check_interval = total_cycle - one_round_time
    
    return max(10, check_interval)  # æœ€å°10ç§’

# ä½¿ç”¨ç¤ºä¾‹
safe_interval = calculate_safe_interval(
    product_count=1,
    store_count=8,
    store_delay=1
)

print(f"å®‰å…¨çš„check_interval: {safe_interval:.0f}ç§’")
```

---

## ğŸš¨ å½“å‰é…ç½®åˆ†æ

### å½“å‰config.jsonå­˜åœ¨çš„é—®é¢˜

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [8ä¸ª],
  "check_interval": 10
}
```

**é—®é¢˜ï¼š**
- å®é™…é¢‘ç‡ï¼š26.67æ¬¡/åˆ†é’Ÿ
- é£é™©çº§åˆ«ï¼šğŸ”´ å±é™©
- è§¦å‘æ¦‚ç‡ï¼š90%ä»¥ä¸Š

### ä¿®å¤å»ºè®®ï¼ˆä¸‰é€‰ä¸€ï¼‰

#### æ–¹æ¡ˆAï¼šå‡å°‘é—¨åº—ï¼ˆæ¨èï¼‰â­

```json
{
  "target_products": [
    {
      "name": "iPhone 16 Plus ç™½è‰² 128GB",
      "part_number": "MXUA3CH/A",
      "color": "ç™½è‰²",
      "storage": "128G"
    }
  ],
  "target_stores": ["R359", "R389", "R401", "R581", "R678"],  // å‡å°‘åˆ°5ä¸ª
  "check_interval": 30  // å¢åŠ åˆ°30ç§’
}
```

**ç»“æœï¼š**
- é¢‘ç‡ï¼š8.57æ¬¡/åˆ†é’Ÿ âœ…
- é£é™©ï¼šæä½

#### æ–¹æ¡ˆBï¼šå¢åŠ é—´éš”

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [8ä¸ª],
  "check_interval": 48  // å¢åŠ åˆ°48ç§’
}
```

**ç»“æœï¼š**
- é¢‘ç‡ï¼š8.57æ¬¡/åˆ†é’Ÿ âœ…
- é£é™©ï¼šæä½

#### æ–¹æ¡ˆCï¼šå¹³è¡¡æ–¹æ¡ˆ

```json
{
  "target_products": [1ä¸ª],
  "target_stores": [6ä¸ª],  // å‡å°‘åˆ°6ä¸ª
  "check_interval": 36     // å¢åŠ åˆ°36ç§’
}
```

**ç»“æœï¼š**
- é¢‘ç‡ï¼š8.57æ¬¡/åˆ†é’Ÿ âœ…
- é£é™©ï¼šæä½

---

## ğŸ“ å¼€å‘å»ºè®®

### æ–°åŠŸèƒ½å¼€å‘æ—¶å¿…é¡»è€ƒè™‘

1. **ä»»ä½•å¢åŠ è¯·æ±‚çš„åŠŸèƒ½ï¼š**
   - å¿…é¡»é‡æ–°è®¡ç®—è¯·æ±‚é¢‘ç‡
   - å¿…é¡»ç¡®ä¿ â‰¤ 10æ¬¡/åˆ†é’Ÿ
   - å¿…é¡»æ·»åŠ å»¶è¿Ÿä¿æŠ¤

2. **ç›‘æ§èŒƒå›´æ‰©å±•ï¼š**
   - é—¨åº—æ•°å¢åŠ  â†’ å¿…é¡»å¢åŠ check_interval
   - äº§å“æ•°å¢åŠ  â†’ å¿…é¡»å‡å°‘é—¨åº—æ•°æˆ–å¢åŠ é—´éš”

3. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - ä¸èƒ½é€šè¿‡å‡å°‘å»¶è¿Ÿæ¥æå‡æ€§èƒ½
   - åªèƒ½é€šè¿‡ä¼˜åŒ–é€»è¾‘ã€å‡å°‘é‡å¤è¯·æ±‚

4. **æµ‹è¯•æ—¶ï¼š**
   - ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿï¼ˆcheck_interval â‰¥ 60ç§’ï¼‰
   - ç›‘æ§å°‘é‡é—¨åº—ï¼ˆâ‰¤ 3ä¸ªï¼‰
   - é¿å…é•¿æ—¶é—´æµ‹è¯•ï¼ˆ< 10åˆ†é’Ÿï¼‰

---

## ğŸ¯ æ€»ç»“

### ä¸‰å¤§é“å¾‹

1. **é¢‘ç‡é™åˆ¶ï¼š10æ¬¡/åˆ†é’Ÿ**
   - è¿™æ˜¯æœ€å…³é”®çš„é™åˆ¶
   - ä»»ä½•æƒ…å†µä¸‹éƒ½ä¸èƒ½è¶…è¿‡
   - å»ºè®®ä¿æŒåœ¨8-9æ¬¡/åˆ†é’Ÿæ›´å®‰å…¨

2. **åŒIPç¦æ­¢å¤šå¼€**
   - åŒä¸€IPè¿è¡Œå¤šä¸ªç¨‹åº = é¢‘ç‡å åŠ 
   - å¿…å®šè§¦å‘é™åˆ¶
   - ä¸åŒIPå¯ä»¥å¹¶è¡Œ

3. **è¡Œä¸ºéšæœºåŒ–**
   - å›ºå®šé—´éš”å®¹æ˜“è¢«è¯†åˆ«
   - å¿…é¡»æ·»åŠ éšæœºæ³¢åŠ¨
   - æ¨¡æ‹Ÿäººç±»è¡Œä¸º

### è®°ä½è¿™äº›æ•°å­—

- **6ç§’** - å•é—¨åº—æ¨èé—´éš”
- **30ç§’** - å¤šé—¨åº—æ¨ècheck_interval
- **10æ¬¡/åˆ†é’Ÿ** - ç»å¯¹å®‰å…¨é¢‘ç‡
- **500æ¬¡/å°æ—¶** - å°æ—¶ç´¯è®¡é™åˆ¶
- **3æ¬¡** - HTTP 541åå¿…é¡»åœæ­¢
- **5ä¸ª** - æ¨èæœ€å¤§é—¨åº—æ•°ï¼ˆ30ç§’é—´éš”ï¼‰

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2025-10-06  
**æ•°æ®æ¥æºï¼š** å®Œæ•´é¡¹ç›®æ–‡ä»¶åˆ†æ + 301æ¬¡å®æµ‹æ•°æ®  
**é€‚ç”¨ç‰ˆæœ¬ï¼š** å½“å‰é¡¹ç›®æ‰€æœ‰ç‰ˆæœ¬

**âš ï¸ é‡è¦æé†’ï¼šåœ¨ä»»ä½•åç»­å¼€å‘ä¸­ï¼Œéƒ½å¿…é¡»éµå®ˆè¿™äº›è§„åˆ™ï¼**

