# 🎉 新功能使用指南

> **版本：** v2.1  
> **新增功能：** 单门店+多产品、香港门店支持  
> **更新时间：** 2025-10-06

---

## ✨ 新功能概述

### 功能1：单门店+多产品支持

**功能说明：**
- 监控单个门店的多个产品型号
- 更低的请求频率
- 更符合实际使用场景

**适用场景：**
- 只关心家附近/公司附近的门店
- 想要监控多个颜色/容量的备选
- 希望增加抢到的概率

**频率优势：**
```
单门店+3产品 = 5.45次/分钟 ✅
单门店+5产品 = 8.57次/分钟 ✅
（比多门店方案更安全！）
```

---

### 功能2：香港门店支持

**功能说明：**
- 支持香港4家Apple Store
- 自动适配香港API端点
- 支持繁体中文显示

**香港门店列表：**
1. R428 - Apple 國際金融中心 (IFC Mall) - 中環
2. R485 - Apple 又一城 (Festival Walk) - 九龍塘
3. R499 - Apple 銅鑼灣 (Causeway Bay) - 銅鑼灣
4. R644 - Apple 尖沙咀 (Canton Road) - 尖沙咀

---

## 🚀 快速开始

### 场景1：单门店+多产品（中国大陆）

#### 步骤1：使用配置模板

```bash
cd /Users/kellychen/CodeBuddy/applepick

# 使用单门店+多产品配置
cp config_single_store_multi_product.json config.json
```

#### 步骤2：验证配置

```bash
python3 rate_calculator.py
# 选择 1 - 分析配置文件
```

**预期输出：**
```
配置参数：
  • 监控产品数：3 个
  • 监控门店数：1 个
  • 检查间隔：30 秒

风险评估：
  • 实际频率：5.45 次/分钟
  • 风险级别：✅ 安全
```

#### 步骤3：运行程序

```bash
# 使用增强版监控器
python3 main_enhanced.py
```

---

### 场景2：香港门店监控

#### 步骤1：使用香港配置

```bash
# 使用香港门店配置
cp config_hongkong_example.json config.json
```

#### 步骤2：确认Part Number

**重要提示：** 香港版iPhone的Part Number格式不同！

```
中国大陆：MXUA3CH/A（以CH/A结尾）
香港：MXUA3ZP/A（以ZP/A结尾）
```

**获取香港Part Number：**
1. 访问香港Apple官网：https://www.apple.com/hk
2. 选择产品配置
3. 查看API请求中的parts参数

#### 步骤3：运行程序

```bash
python3 main_enhanced.py
```

---

## 📝 配置详解

### 配置文件结构（新增字段）

```json
{
  "region": "CN",  // 新增：区域选择 CN=中国大陆, HK=香港
  
  "target_products": [
    {
      "name": "产品名称",
      "part_number": "型号编号",
      "color": "颜色",
      "storage": "容量"
    }
  ],
  
  "target_stores": ["R678"],  // 可以是1个或多个
  
  "check_interval": 30
}
```

### 区域配置

| 区域代码 | 区域名称 | API端点 | Part Number格式 |
|---------|---------|---------|----------------|
| **CN** | 中国大陆 | apple.com.cn | CH/A |
| **HK** | 香港 | apple.com/hk | ZP/A |

---

## 🎯 使用场景示例

### 场景A：上海白领（单门店+多产品）

**需求：**
- 上班族，只能去公司附近的静安Apple Store
- 想要iPhone 16 Plus，但颜色和容量还没决定
- 希望多个备选，总有一款能买到

**配置：**

```json
{
  "region": "CN",
  "target_products": [
    {"part_number": "MXUA3CH/A", "name": "白色 128GB"},
    {"part_number": "MXUB3CH/A", "name": "白色 256GB"},
    {"part_number": "MXUC3CH/A", "name": "黑色 128GB"},
    {"part_number": "MXUD3CH/A", "name": "黑色 256GB"},
    {"part_number": "MXUE3CH/A", "name": "蓝色 128GB"}
  ],
  "target_stores": ["R678"],
  "check_interval": 30
}
```

**频率分析：**
```
5个产品 × 1个门店 = 5次请求
总周期 = 5 + 30 = 35秒
频率 = 5/35×60 = 8.57次/分钟 ✅ 安全
```

---

### 场景B：香港用户（香港门店）

**需求：**
- 住在香港中环
- 想在IFC Mall的Apple Store购买
- 监控1-2个型号

**配置：**

```json
{
  "region": "HK",
  "target_products": [
    {
      "part_number": "MXUA3ZP/A",
      "name": "iPhone 16 Plus White 128GB"
    }
  ],
  "target_stores": ["R428"],
  "check_interval": 30
}
```

**频率分析：**
```
1个产品 × 1个门店 = 1次请求
总周期 = 1 + 30 = 31秒
频率 = 1/31×60 = 1.94次/分钟 ✅ 极度安全
```

---

### 场景C：多个香港门店

**需求：**
- 愿意去香港任何一家Apple Store
- 监控2个型号

**配置：**

```json
{
  "region": "HK",
  "target_products": [
    {"part_number": "MXUA3ZP/A", "name": "White 128GB"},
    {"part_number": "MXUB3ZP/A", "name": "White 256GB"}
  ],
  "target_stores": ["R428", "R485", "R499", "R644"],
  "check_interval": 48
}
```

**频率分析：**
```
2个产品 × 4个门店 = 8次请求
总周期 = 8 + 48 = 56秒
频率 = 8/56×60 = 8.57次/分钟 ✅ 安全
```

---

## 🔧 使用增强版监控器

### 创建启动脚本

创建 `main_enhanced.py`：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Apple Store 库存监控程序 - 增强版
支持单门店+多产品、香港门店
"""

import sys
import json
import signal
from pathlib import Path
from colorama import init, Fore, Style

# 导入增强版监控器
from apple_store_monitor_enhanced import AppleStoreMonitorEnhanced
from notifier import Notifier
from logger_config import setup_logger
from threading import Event

init(autoreset=True)
stop_event = Event()
logger = setup_logger()


def load_config(config_path='config.json'):
    """加载配置文件"""
    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            config = json.load(f)
        
        # 验证必要字段
        required_fields = ['target_products']
        for field in required_fields:
            if field not in config:
                raise ValueError(f"配置文件缺少必要字段: {field}")
        
        # 设置默认区域
        if 'region' not in config:
            config['region'] = 'CN'
            logger.warning("未指定区域，使用默认值：CN（中国大陆）")
        
        return config
    
    except Exception as e:
        logger.error(f"加载配置文件失败: {e}")
        sys.exit(1)


def signal_handler(sig, frame):
    """处理中断信号"""
    print(f"\n{Fore.YELLOW}收到中断信号，正在安全退出...{Style.RESET_ALL}\n")
    stop_event.set()


def main():
    """主函数"""
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    print(f"\n{Fore.CYAN}{'='*70}")
    print(f"🍎  Apple Store 库存实时监控系统 v2.1 (增强版)")
    print(f"{'='*70}{Style.RESET_ALL}\n")
    
    # 加载配置
    logger.info("正在加载配置...")
    config = load_config()
    
    # 初始化增强版监控器
    logger.info("正在初始化增强版监控器...")
    monitor = AppleStoreMonitorEnhanced(config, stop_event)
    
    # 显示配置信息
    region_name = monitor.region_config['name']
    product_count = len(config['target_products'])
    store_count = len(config.get('target_stores', []))
    
    print(f"{Fore.GREEN}✅ 监控配置：{Style.RESET_ALL}")
    print(f"  • 区域：{region_name}")
    print(f"  • 产品数：{product_count} 个")
    print(f"  • 门店数：{store_count} 个")
    print(f"  • 检查间隔：{config.get('check_interval', 30)} 秒")
    
    # 计算频率
    one_round = product_count * store_count
    total_cycle = one_round + config.get('check_interval', 30)
    rate = one_round / total_cycle * 60
    
    print(f"  • 预计频率：{rate:.2f} 次/分钟")
    
    if rate > 10:
        print(f"\n{Fore.RED}⚠️  警告：频率可能过高！{Style.RESET_ALL}")
        print(f"建议使用 rate_calculator.py 验证配置\n")
    else:
        print(f"  • 安全性：✅ 安全\n")
    
    # 初始化通知器
    notifier = Notifier(config)
    
    print(f"{Fore.GREEN}✨ 监控已启动！{Style.RESET_ALL}\n")
    print(f"{Fore.YELLOW}💡 提示: 按 Ctrl+C 可随时停止{Style.RESET_ALL}\n")
    
    # 开始监控循环
    try:
        iteration = 0
        while not stop_event.is_set():
            iteration += 1
            logger.info(f"开始第 {iteration} 轮检查...")
            
            # 检查库存
            results = monitor.check_multiple_products(
                config['target_products'],
                config.get('target_stores')
            )
            
            # 处理结果和发送通知
            for part_number, data in results.items():
                product = data.get('product', {})
                result = data.get('result', {})
                
                if result.get('success'):
                    available_stores = result.get('available_stores', [])
                    
                    if available_stores:
                        if len(available_stores) == 1:
                            notifier.notify_stock_available(product, available_stores[0])
                        else:
                            notifier.notify_multiple_stores_available(product, available_stores)
                        
                        logger.info(f"🎉 {product.get('name')} 在 {len(available_stores)} 个门店有货！")
            
            # 等待下次检查
            check_interval = config.get('check_interval', 30)
            logger.info(f"本轮检查完成，{check_interval}秒后进行下一轮...")
            stop_event.wait(check_interval)
    
    except KeyboardInterrupt:
        pass
    except Exception as e:
        logger.error(f"程序异常: {e}")
    
    # 导出历史
    if config.get('save_history', True):
        logger.info("正在导出历史记录...")
        monitor.export_history()
    
    print(f"\n{Fore.CYAN}程序已退出。感谢使用！{Style.RESET_ALL}\n")
    logger.info("程序正常退出")


if __name__ == "__main__":
    main()
```

### 运行增强版

```bash
# 赋予执行权限
chmod +x main_enhanced.py

# 运行
python3 main_enhanced.py
```

---

## 📊 频率对比

### 单门店 vs 多门店

| 配置 | 产品数 | 门店数 | 频率 | 安全性 |
|------|--------|--------|------|--------|
| 单门店+3产品 | 3 | 1 | 5.45次/分 | ✅✅✅ |
| 单门店+5产品 | 5 | 1 | 8.57次/分 | ✅✅✅ |
| 单产品+5门店 | 1 | 5 | 8.57次/分 | ✅✅ |
| 单产品+8门店 | 1 | 8 | 26.67次/分 | ❌❌ |

**结论：** 单门店+多产品的频率更低，更安全！

---

## ⚠️ 重要提醒

### Part Number差异

**中国大陆：**
```
iPhone 16 Plus 白色 128GB: MXUA3CH/A
```

**香港：**
```
iPhone 16 Plus 白色 128GB: MXUA3ZP/A
```

**注意：** 结尾不同（CH/A vs ZP/A）

### API端点

**中国大陆：**
```
https://www.apple.com.cn/shop/retail/pickup-message
```

**香港：**
```
https://www.apple.com/hk/shop/retail/pickup-message
```

**自动处理：** 增强版监控器会根据region自动选择

---

## 🎯 最佳实践

### 1. 单门店+多产品

**推荐配置：**
- 产品数：3-5个
- 门店数：1个
- 间隔：30秒
- 频率：5-9次/分钟

**优势：**
- 频率最低
- 配置最简单
- 最符合使用习惯

### 2. 香港门店

**推荐配置：**
- 产品数：1-2个
- 门店数：1-2个
- 间隔：30秒
- 频率：2-4次/分钟

**注意：**
- 使用ZP/A结尾的Part Number
- 设置region为"HK"

---

## 🔍 故障排查

### 问题1：香港门店查询失败

**检查：**
1. region设置是否为"HK"
2. Part Number是否是ZP/A结尾
3. 门店编号是否正确

### 问题2：频率仍然过高

**解决：**
```bash
# 使用计算工具验证
python3 rate_calculator.py

# 增加check_interval
# 或减少产品/门店数量
```

### 问题3：程序无法启动

**检查：**
1. 是否安装了所有依赖
2. 配置文件格式是否正确
3. apple_stores_hongkong.json是否存在

---

## 📚 相关文档

- **单门店多产品分析.md** - 详细的频率分析
- **Apple_API_防爬虫规则总结.md** - API限制规则
- **rate_calculator.py** - 频率计算工具

---

## ✅ 快速检查清单

使用新功能前：

- [ ] 已选择区域（CN或HK）
- [ ] Part Number格式正确
- [ ] 使用rate_calculator验证
- [ ] 频率 ≤ 10次/分钟
- [ ] 已测试运行10分钟

---

**更新时间：** 2025-10-06  
**版本：** v2.1  
**新功能：** 单门店+多产品、香港门店支持

**🎉 享受新功能！**


