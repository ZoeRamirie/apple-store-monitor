# 🎯 Apple API 限制快速参考卡

> **随时查阅** - 开发时放在手边的速查表

---

## 📊 核心数字（必记）

```
✅ 10次/分钟  - 绝对安全（301次实测通过）
⚠️  15次/分钟  - 可能触发
🔴 20次/分钟  - 高风险
💀 30次/分钟  - 必定触发
```

---

## ⏱️ 推荐间隔

| 操作 | 间隔 |
|------|------|
| 单门店查询 | 6秒 |
| 多门店查询（门店间） | 1秒 |
| check_interval（5门店） | 30秒 |
| check_interval（8门店） | 48秒 |
| check_interval（10门店） | 60秒 |

---

## 🚫 绝对禁止

```
❌ 同一IP多开程序
❌ check_interval < 10秒（多门店）
❌ 监控 > 10个门店（单产品）
❌ 固定间隔（如精确每3秒）
❌ 忽略HTTP 541继续请求
```

---

## 📐 快速计算

```python
# 公式
请求频率 = (产品数 × 门店数) / (门店数 + 检查间隔) × 60

# 示例
产品: 1, 门店: 5, 间隔: 30秒
频率 = (1 × 5) / (5 + 30) × 60 = 8.57次/分钟 ✅
```

---

## 🛡️ 保护机制

```python
# 必须实现
1. 随机延迟（±20%）
2. 轮换User-Agent
3. HTTP 541检测
4. 连续3次错误停止
5. 每100次重建Session
```

---

## 📋 安全配置

### 单产品5门店（标准）⭐

```json
{
  "target_products": [1个],
  "target_stores": [5个],
  "check_interval": 30
}
// 8.57次/分钟 ✅
```

### 单产品8门店（最大）

```json
{
  "target_products": [1个],
  "target_stores": [8个],
  "check_interval": 48
}
// 8.57次/分钟 ✅
```

---

## 🚨 问题排查

### HTTP 541错误

```
原因: 频率超标
处理: 立即停止，等待60秒
预防: 降低频率到≤10次/分钟
```

### 连续失败

```
检查: 
1. 计算实际频率
2. 查看monitor.log
3. 使用rate_calculator.py
```

---

## 🔢 限制汇总

| 维度 | 限制 |
|------|------|
| 每分钟 | ≤ 10次 |
| 每小时 | ≤ 500次 |
| 每24小时 | ≤ 3000次 |
| HTTP 541触发 | 3次/小时 → 黑名单 |

---

## 🛠️ 实用命令

```bash
# 计算配置安全性
python3 rate_calculator.py

# 查看日志
tail -f monitor.log | grep "HTTP 541"

# 使用安全配置
cp config_safe.json config.json

# 测试API
python3 -c "from apple_store_monitor import *; ..."
```

---

## 💡 开发提醒

```
每次修改配置前：
1. 使用rate_calculator.py计算
2. 确保 ≤ 10次/分钟
3. 备份旧配置
4. 测试10分钟
5. 监控日志
```

---

## 📞 紧急情况

### 触发限制怎么办？

```
1. 立即停止程序（Ctrl+C）
2. 等待60秒
3. 检查配置（rate_calculator.py）
4. 修复频率问题
5. 使用更长间隔重启
```

### 配置不确定？

```
使用安全配置：
cp config_safe.json config.json
```

---

**记住：宁可慢一点，也不要触发限制！**

**⭐ 10次/分钟是红线！**


