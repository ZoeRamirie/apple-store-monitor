# ğŸ”§ ä»£ç æ”¹è¿›å»ºè®® - åŸºäºé˜²çˆ¬è™«è§„åˆ™

> **ç›®çš„ï¼š** åœ¨åç»­å¼€å‘ä¸­å¼ºåŒ–å¯¹Apple APIé™åˆ¶çš„ä¿æŠ¤  
> **ä¼˜å…ˆçº§ï¼š** é«˜ï¼ˆå¿…é¡»å®ç°ï¼‰

---

## ğŸ¯ å¿…é¡»å®ç°çš„æ”¹è¿›

### 1. éšæœºåŒ–User-Agent â­â­â­â­â­

**å½“å‰é—®é¢˜ï¼š**

`config.json` å’Œ `apple_store_monitor.py` éƒ½ä½¿ç”¨å›ºå®šçš„User-Agentï¼Œå®¹æ˜“è¢«è¯†åˆ«ä¸ºæœºå™¨äººã€‚

```python
# å½“å‰ä»£ç  - apple_store_monitor.py: 64-65è¡Œ
headers = {
    'User-Agent': self.config.get('user_agent', 
        'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'),
```

**é—®é¢˜ï¼š**
- ğŸ”´ å›ºå®šUser-Agent
- ğŸ”´ å®¹æ˜“è¢«è¯†åˆ«ä¸ºæœºå™¨äºº
- ğŸ”´ å¢åŠ è¢«é™åˆ¶çš„é£é™©

**æ”¹è¿›æ–¹æ¡ˆï¼š**

åœ¨ `apple_store_monitor.py` é¡¶éƒ¨æ·»åŠ ï¼š

```python
import random

# User-Agentæ± 
USER_AGENTS = [
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/120.0.0.0',
]
```

ä¿®æ”¹ `_create_session` æ–¹æ³•ï¼ˆç¬¬59-85è¡Œï¼‰ï¼š

```python
def _create_session(self) -> requests.Session:
    """åˆ›å»ºHTTPä¼šè¯"""
    session = requests.Session()
    
    headers = {
        'User-Agent': random.choice(USER_AGENTS),  # âœ… éšæœºé€‰æ‹©
        'Accept': 'application/json',
        'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
        'Accept-Encoding': 'gzip, deflate, br',
        'Referer': 'https://www.apple.com.cn/shop/buy-iphone',
        'Origin': 'https://www.apple.com.cn',
        'Connection': 'keep-alive',
        'Cache-Control': 'no-cache',
    }
    session.headers.update(headers)
    
    # ... å…¶ä»–ä»£ç ä¿æŒä¸å˜
    return session
```

**å¦å¤–ï¼š** åœ¨æ¯æ¬¡è¯·æ±‚å‰ä¹Ÿå¯ä»¥æ›´æ¢User-Agentï¼š

```python
def check_product_availability(self, part_number: str, store_number: str = None) -> Dict:
    """æ£€æŸ¥å•†å“åº“å­˜"""
    try:
        # âœ… æ¯æ¬¡è¯·æ±‚å‰æ›´æ¢User-Agent
        self.session.headers['User-Agent'] = random.choice(USER_AGENTS)
        
        # ... åŸæœ‰ä»£ç 
```

---

### 2. éšæœºå»¶è¿Ÿé—´éš” â­â­â­â­â­

**å½“å‰é—®é¢˜ï¼š**

```python
# apple_store_monitor.py: 305è¡Œ
self._interruptible_sleep(1)  # å›ºå®š1ç§’ï¼Œå¤ªè§„å¾‹
```

**é—®é¢˜ï¼š**
- ğŸ”´ å›ºå®šé—´éš”
- ğŸ”´ æå…¶è§„å¾‹
- ğŸ”´ æ˜æ˜¾çš„æœºå™¨äººç‰¹å¾

**æ”¹è¿›æ–¹æ¡ˆï¼š**

åœ¨ `AppleStoreMonitor` ç±»ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼š

```python
def _smart_delay(self, base_delay: float, variance: float = 0.2):
    """
    æ™ºèƒ½å»¶è¿Ÿï¼šæ·»åŠ éšæœºæ³¢åŠ¨ï¼Œæ¨¡æ‹Ÿäººç±»è¡Œä¸º
    
    Args:
        base_delay: åŸºç¡€å»¶è¿Ÿï¼ˆç§’ï¼‰
        variance: æ³¢åŠ¨å¹…åº¦ï¼ˆ0.2 = Â±20%ï¼‰
    """
    import random
    
    min_delay = base_delay * (1 - variance)
    max_delay = base_delay * (1 + variance)
    delay = random.uniform(min_delay, max_delay)
    
    logger.debug(f"å»¶è¿Ÿ {delay:.2f} ç§’")
    self._interruptible_sleep(delay)
```

**æ›¿æ¢æ‰€æœ‰å›ºå®šå»¶è¿Ÿï¼š**

```python
# åŸæ¥ï¼š
self._interruptible_sleep(1)

# æ”¹ä¸ºï¼š
self._smart_delay(1, 0.2)  # 0.8-1.2ç§’éšæœº

# åŸæ¥ï¼š
self._interruptible_sleep(3)

# æ”¹ä¸ºï¼š
self._smart_delay(3, 0.15)  # 2.55-3.45ç§’éšæœº

# åŸæ¥ï¼š
self._interruptible_sleep(10)

# æ”¹ä¸ºï¼š
self._smart_delay(10, 0.1)  # 9-11ç§’éšæœº
```

**è¿›ä¸€æ­¥ä¼˜åŒ–ï¼šä½¿ç”¨æ­£æ€åˆ†å¸ƒ**

```python
def _human_like_delay(self, mean: float, std: float = 0.3):
    """
    æ›´æ¥è¿‘äººç±»çš„å»¶è¿Ÿæ¨¡å¼ï¼ˆæ­£æ€åˆ†å¸ƒï¼‰
    
    Args:
        mean: å¹³å‡å»¶è¿Ÿ
        std: æ ‡å‡†å·®ï¼ˆç›¸å¯¹å€¼ï¼‰
    """
    import random
    
    # æ­£æ€åˆ†å¸ƒ
    delay = random.gauss(mean, mean * std)
    
    # é™åˆ¶åœ¨åˆç†èŒƒå›´å†…
    min_delay = mean * 0.5
    max_delay = mean * 1.5
    delay = max(min_delay, min(max_delay, delay))
    
    self._interruptible_sleep(delay)
```

---

### 3. ä¼šè¯ç®¡ç†å’Œè½®æ¢ â­â­â­â­

**æ·»åŠ è¯·æ±‚è®¡æ•°å™¨ï¼š**

åœ¨ `__init__` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
def __init__(self, config: dict, stop_event=None):
    # ... ç°æœ‰ä»£ç 
    self.request_count = 0  # âœ… æ·»åŠ è®¡æ•°å™¨
    self.session_start_time = datetime.now()  # âœ… ä¼šè¯å¼€å§‹æ—¶é—´
```

**å®šæœŸé‡å»ºSessionï¼š**

åœ¨ `check_product_availability` æ–¹æ³•ä¸­ï¼š

```python
def check_product_availability(self, part_number: str, store_number: str = None) -> Dict:
    try:
        # âœ… æ¯100æ¬¡è¯·æ±‚é‡å»ºSession
        self.request_count += 1
        if self.request_count % 100 == 0:
            logger.info(f"å·²å‘é€{self.request_count}æ¬¡è¯·æ±‚ï¼Œé‡å»ºSession...")
            self.session.close()
            self.session = self._create_session()
        
        # âœ… æ¯å°æ—¶é‡ç½®è®¡æ•°å™¨
        if (datetime.now() - self.session_start_time).total_seconds() > 3600:
            logger.info("å·²è¿è¡Œ1å°æ—¶ï¼Œé‡ç½®è®¡æ•°å™¨...")
            self.request_count = 0
            self.session_start_time = datetime.now()
        
        # ... åŸæœ‰ä»£ç 
```

---

### 4. å¢å¼ºçš„é”™è¯¯ä¿æŠ¤ â­â­â­â­

**å½“å‰ä»£ç ï¼š**

```python
# apple_store_monitor.py: 284-294è¡Œ
elif 'HTTP 541' in str(result.get('error', '')):
    error_count += 1
    
    if error_count >= 3:
        logger.warning(f"âš ï¸  è¿ç»­{error_count}æ¬¡é‡åˆ°APIé™åˆ¶ï¼")
        skip_remaining = True
```

**æ”¹è¿›æ–¹æ¡ˆï¼šæŒ‡æ•°é€€é¿**

```python
def _exponential_backoff(self, error_count: int) -> float:
    """
    æŒ‡æ•°é€€é¿ç­–ç•¥
    
    Args:
        error_count: è¿ç»­é”™è¯¯æ¬¡æ•°
        
    Returns:
        ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰
    """
    backoff_times = {
        1: 10,   # ç¬¬1æ¬¡: 10ç§’
        2: 30,   # ç¬¬2æ¬¡: 30ç§’
        3: 60,   # ç¬¬3æ¬¡: 60ç§’
        4: 120,  # ç¬¬4æ¬¡: 120ç§’
    }
    
    return backoff_times.get(error_count, 300)  # é»˜è®¤5åˆ†é’Ÿ

# ä½¿ç”¨ï¼š
elif 'HTTP 541' in str(result.get('error', '')):
    error_count += 1
    backoff_time = self._exponential_backoff(error_count)
    
    logger.warning(f"âš ï¸  HTTP 541é”™è¯¯ (ç¬¬{error_count}æ¬¡)")
    logger.warning(f"ç­‰å¾…{backoff_time}ç§’åç»§ç»­...")
    
    self._interruptible_sleep(backoff_time)
    
    if error_count >= 3:
        logger.error(f"è¿ç»­{error_count}æ¬¡è§¦å‘é™åˆ¶ï¼Œè·³è¿‡å‰©ä½™é—¨åº—")
        skip_remaining = True
```

---

### 5. è¯·æ±‚é¢‘ç‡ç›‘æ§ â­â­â­

**æ·»åŠ å®æ—¶é¢‘ç‡ç›‘æ§ï¼š**

åœ¨ `__init__` æ–¹æ³•ä¸­ï¼š

```python
def __init__(self, config: dict, stop_event=None):
    # ... ç°æœ‰ä»£ç 
    self.request_times = []  # âœ… è®°å½•è¯·æ±‚æ—¶é—´
```

**æ·»åŠ ç›‘æ§æ–¹æ³•ï¼š**

```python
def _record_request(self):
    """è®°å½•è¯·æ±‚æ—¶é—´"""
    now = time.time()
    self.request_times.append(now)
    
    # åªä¿ç•™æœ€è¿‘60ç§’çš„è®°å½•
    cutoff = now - 60
    self.request_times = [t for t in self.request_times if t > cutoff]
    
    # è®¡ç®—å½“å‰é¢‘ç‡
    current_rate = len(self.request_times)
    
    # è­¦å‘Š
    if current_rate > 10:
        logger.warning(f"âš ï¸  å½“å‰é¢‘ç‡: {current_rate}æ¬¡/åˆ†é’Ÿ - è¶…è¿‡å®‰å…¨é˜ˆå€¼ï¼")
    elif current_rate > 8:
        logger.info(f"â„¹ï¸  å½“å‰é¢‘ç‡: {current_rate}æ¬¡/åˆ†é’Ÿ - æ¥è¿‘é˜ˆå€¼")
    
    return current_rate

# åœ¨æ¯æ¬¡è¯·æ±‚å‰è°ƒç”¨ï¼š
def check_product_availability(self, part_number: str, store_number: str = None):
    try:
        # âœ… è®°å½•å¹¶æ£€æŸ¥é¢‘ç‡
        rate = self._record_request()
        
        # å¦‚æœé¢‘ç‡è¿‡é«˜ï¼Œä¸»åŠ¨å»¶è¿Ÿ
        if rate > 12:
            logger.warning("é¢‘ç‡è¿‡é«˜ï¼Œé¢å¤–å»¶è¿Ÿ5ç§’...")
            self._interruptible_sleep(5)
        
        # ... åŸæœ‰ä»£ç 
```

---

### 6. é…ç½®éªŒè¯ â­â­â­

**åœ¨å¯åŠ¨æ—¶éªŒè¯é…ç½®å®‰å…¨æ€§ï¼š**

```python
def _validate_config(self):
    """éªŒè¯é…ç½®æ˜¯å¦å®‰å…¨"""
    product_count = len(self.config.get('target_products', []))
    
    if self.config.get('all_stores', False):
        store_count = len(self.stores)
    else:
        store_count = len(self.config.get('target_stores', []))
    
    check_interval = self.config.get('check_interval', 30)
    
    # è®¡ç®—é¢‘ç‡
    one_round = store_count * 1  # å‡è®¾é—¨åº—é—´1ç§’
    total_cycle = one_round + check_interval
    rate = (product_count * store_count) / total_cycle * 60
    
    logger.info(f"é…ç½®éªŒè¯:")
    logger.info(f"  äº§å“æ•°: {product_count}")
    logger.info(f"  é—¨åº—æ•°: {store_count}")
    logger.info(f"  æ£€æŸ¥é—´éš”: {check_interval}ç§’")
    logger.info(f"  é¢„è®¡é¢‘ç‡: {rate:.2f}æ¬¡/åˆ†é’Ÿ")
    
    if rate > 15:
        logger.error(f"âš ï¸  é…ç½®ä¸å®‰å…¨ï¼é¢‘ç‡{rate:.2f}æ¬¡/åˆ†é’Ÿ > 15æ¬¡/åˆ†é’Ÿ")
        logger.error(f"å»ºè®®: å‡å°‘é—¨åº—æ•°æˆ–å¢åŠ check_interval")
        raise ValueError("é…ç½®ä¸å®‰å…¨ï¼Œé¢‘ç‡è¿‡é«˜")
    elif rate > 10:
        logger.warning(f"âš ï¸  é…ç½®æœ‰é£é™©ï¼é¢‘ç‡{rate:.2f}æ¬¡/åˆ†é’Ÿ > 10æ¬¡/åˆ†é’Ÿ")
        logger.warning(f"å»ºè®®: å‡å°‘é—¨åº—æ•°æˆ–å¢åŠ check_interval")
        
        # è¯¢é—®ç”¨æˆ·
        choice = input("æ˜¯å¦ç»§ç»­ï¼Ÿ(y/n): ").strip().lower()
        if choice != 'y':
            raise ValueError("ç”¨æˆ·å–æ¶ˆ")
    else:
        logger.info(f"âœ… é…ç½®å®‰å…¨")
    
    return rate

# åœ¨__init__ä¸­è°ƒç”¨ï¼š
def __init__(self, config: dict, stop_event=None):
    # ... ç°æœ‰ä»£ç 
    self._validate_config()  # âœ… éªŒè¯é…ç½®
```

---

## ğŸ“ ä»£ç æ–‡ä»¶ä¿®æ”¹æ¸…å•

### apple_store_monitor.py

**éœ€è¦æ·»åŠ çš„ä»£ç ï¼š**

```python
# 1. é¡¶éƒ¨å¯¼å…¥å’Œå¸¸é‡
import random
from datetime import datetime

USER_AGENTS = [
    # ... User-Agentæ± 
]

# 2. ä¿®æ”¹__init__æ–¹æ³•
def __init__(self, config: dict, stop_event=None):
    # æ·»åŠ ï¼š
    self.request_count = 0
    self.session_start_time = datetime.now()
    self.request_times = []
    
    # åœ¨æœ€åæ·»åŠ ï¼š
    self._validate_config()

# 3. æ·»åŠ æ–°æ–¹æ³•
def _smart_delay(self, base_delay: float, variance: float = 0.2):
    # ... å®ç°

def _exponential_backoff(self, error_count: int) -> float:
    # ... å®ç°

def _record_request(self):
    # ... å®ç°

def _validate_config(self):
    # ... å®ç°

# 4. ä¿®æ”¹_create_session
def _create_session(self):
    headers = {
        'User-Agent': random.choice(USER_AGENTS),  # ä¿®æ”¹è¿™é‡Œ
        # ...
    }

# 5. ä¿®æ”¹check_product_availability
def check_product_availability(self, part_number: str, store_number: str = None):
    try:
        # æ·»åŠ ï¼š
        self.request_count += 1
        rate = self._record_request()
        
        # æ·»åŠ ï¼šæ¯100æ¬¡é‡å»ºSession
        if self.request_count % 100 == 0:
            # ...
        
        # ä¿®æ”¹User-Agent
        self.session.headers['User-Agent'] = random.choice(USER_AGENTS)
        
        # ... åŸæœ‰ä»£ç 

# 6. æ›¿æ¢æ‰€æœ‰_interruptible_sleepä¸º_smart_delay
# æŸ¥æ‰¾ï¼šself._interruptible_sleep(1)
# æ›¿æ¢ä¸ºï¼šself._smart_delay(1, 0.2)
```

---

### main.py

**æ·»åŠ é…ç½®è­¦å‘Šï¼š**

```python
def main():
    # åœ¨åŠ è½½é…ç½®åæ·»åŠ ï¼š
    config = load_config()
    
    # âœ… æ·»åŠ é…ç½®æ£€æŸ¥
    from rate_calculator import calculate_request_rate
    
    product_count = len(config['target_products'])
    store_count = len(config.get('target_stores', []))
    if config.get('all_stores', False):
        store_count = 48  # æˆ–ä»storesæ–‡ä»¶è¯»å–
    
    result = calculate_request_rate(
        product_count,
        store_count,
        1,
        config.get('check_interval', 30)
    )
    
    if not result['safe']:
        print(f"\n{Fore.RED}{'='*70}")
        print(f"âš ï¸  è­¦å‘Šï¼šå½“å‰é…ç½®ä¸å®‰å…¨ï¼")
        print(f"{'='*70}{Style.RESET_ALL}")
        print(f"\nå®é™…é¢‘ç‡ï¼š{result['rate_per_minute']:.2f}æ¬¡/åˆ†é’Ÿ")
        print(f"å®‰å…¨æ ‡å‡†ï¼šâ‰¤ 10æ¬¡/åˆ†é’Ÿ")
        print(f"\nå»ºè®®ï¼š")
        print(f"  1. ä½¿ç”¨ python3 rate_calculator.py æŸ¥çœ‹è¯¦ç»†åˆ†æ")
        print(f"  2. ä½¿ç”¨ cp config_safe.json config.json åˆ‡æ¢åˆ°å®‰å…¨é…ç½®")
        print(f"  3. æˆ–æ‰‹åŠ¨ä¿®æ”¹é…ç½®")
        print(f"\n{Fore.RED}{'='*70}{Style.RESET_ALL}\n")
        
        choice = input("æ˜¯å¦ç»§ç»­ï¼Ÿ(y/n): ").strip().lower()
        if choice != 'y':
            print("å·²é€€å‡º")
            return
    
    # ... ç»§ç»­åŸæœ‰ä»£ç 
```

---

## ğŸ¯ å®ç°ä¼˜å…ˆçº§

### ç«‹å³å®ç°ï¼ˆP0ï¼‰

1. **éšæœºåŒ–User-Agent** - æœ€å®¹æ˜“å®ç°ï¼Œæ•ˆæœæ˜¾è‘—
2. **éšæœºå»¶è¿Ÿé—´éš”** - å…³é”®ä¿æŠ¤æªæ–½
3. **é…ç½®éªŒè¯** - é˜²æ­¢é…ç½®é”™è¯¯

### å°½å¿«å®ç°ï¼ˆP1ï¼‰

4. **æŒ‡æ•°é€€é¿é‡è¯•** - å¢å¼ºå®¹é”™æ€§
5. **è¯·æ±‚é¢‘ç‡ç›‘æ§** - å®æ—¶ç›‘æ§å’Œé¢„è­¦

### å¯é€‰å®ç°ï¼ˆP2ï¼‰

6. **ä¼šè¯ç®¡ç†** - é•¿æœŸè¿è¡Œçš„ä¼˜åŒ–

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```python
# test_monitor.py
def test_smart_delay():
    """æµ‹è¯•æ™ºèƒ½å»¶è¿Ÿ"""
    monitor = AppleStoreMonitor(config, None)
    
    delays = []
    for _ in range(10):
        start = time.time()
        monitor._smart_delay(1, 0.2)
        delays.append(time.time() - start)
    
    # åº”è¯¥æœ‰å˜åŒ–
    assert len(set([round(d, 1) for d in delays])) > 1
    
    # åœ¨åˆç†èŒƒå›´å†…
    assert all(0.8 <= d <= 1.2 for d in delays)

def test_request_rate_monitoring():
    """æµ‹è¯•é¢‘ç‡ç›‘æ§"""
    monitor = AppleStoreMonitor(config, None)
    
    for _ in range(15):
        rate = monitor._record_request()
    
    # åº”è¯¥è®°å½•15æ¬¡
    assert rate == 15
```

### 2. é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•ä¿®æ”¹åçš„é…ç½®
python3 -c "
from apple_store_monitor import AppleStoreMonitor
from rate_calculator import calculate_request_rate

config = {...}
monitor = AppleStoreMonitor(config, None)
# æµ‹è¯•10æ¬¡è¯·æ±‚
for i in range(10):
    monitor.check_product_availability('MXUA3CH/A', 'R359')
"
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

å®ç°è¿™äº›æ”¹è¿›åï¼š

- âœ… **é™ä½è¢«è¯†åˆ«ä¸ºæœºå™¨äººçš„é£é™©**
- âœ… **å‡å°‘HTTP 541é”™è¯¯çš„é¢‘ç‡**
- âœ… **æé«˜é•¿æ—¶é—´è¿è¡Œçš„ç¨³å®šæ€§**
- âœ… **æ›´å¥½çš„é”™è¯¯æ¢å¤èƒ½åŠ›**
- âœ… **å®æ—¶ç›‘æ§å’Œé¢„è­¦**

---

## ğŸ”„ æ¸è¿›å¼å®æ–½

### ç¬¬ä¸€é˜¶æ®µï¼ˆ1å¤©ï¼‰

- å®ç°éšæœºUser-Agent
- å®ç°éšæœºå»¶è¿Ÿ
- æ·»åŠ é…ç½®éªŒè¯

### ç¬¬äºŒé˜¶æ®µï¼ˆ1-2å¤©ï¼‰

- å®ç°æŒ‡æ•°é€€é¿
- å®ç°é¢‘ç‡ç›‘æ§
- æ·»åŠ æµ‹è¯•

### ç¬¬ä¸‰é˜¶æ®µï¼ˆæŒ‰éœ€ï¼‰

- ä¼šè¯ç®¡ç†
- é«˜çº§ä¼˜åŒ–
- æ€§èƒ½è°ƒä¼˜

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š** 2025-10-06  
**ç›®çš„ï¼š** æŒ‡å¯¼åç»­ä»£ç æ”¹è¿›  
**é‡è¦æ€§ï¼š** â­â­â­â­â­


